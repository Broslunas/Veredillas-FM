---
---

<button id="cmd-palette-trigger" class="cmd-btn" aria-label="Abrir Buscador">
  <span class="cmd-icon">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </span>
  <span class="cmd-hint">
    <kbd>Ctrl</kbd> K
  </span>
</button>

<dialog id="cmd-palette" class="cmd-palette">
  <div class="palette-container">
    <div class="palette-header">
      <div class="search-icon-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      <input type="text" id="palette-input" placeholder="Buscar episodios, equipo, posts..." autocomplete="off" />
      <div class="keyboard-hints">
        <span class="hint-item"><kbd>‚áÖ</kbd> navegar</span>
        <span class="hint-item"><kbd>‚Üµ</kbd> seleccionar</span>
        <span class="hint-item"><kbd>Esc</kbd> cerrar</span>
      </div>
    </div>
    
    <div id="palette-results" class="palette-results">
        <div class="empty-state">
            <p>Escribe para buscar...</p>
            <div class="quick-actions">
                <span class="qa-title">Acciones R√°pidas</span>
                <div class="qa-grid">
                   <a href="/episodes" class="qa-item"><span class="qa-icon">üéôÔ∏è</span> Ir a Episodios</a>
                   <a href="/equipo" class="qa-item"><span class="qa-icon">üë•</span> Ver Equipo</a>
                   <a href="/blog" class="qa-item"><span class="qa-icon">üìù</span> Leer Blog</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="palette-footer">
        <span class="results-count" id="results-count"></span>
        <span class="brand">Veredillas FM</span>
    </div>
  </div>
</dialog>

<style>
  /* Button Trigger Styles */
  .cmd-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
  }

  .cmd-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--color-text-main);
  }

  .cmd-hint {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    font-size: 0.75rem;
    opacity: 0.7;
  }

  kbd {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.1rem 0.3rem;
    border-radius: 4px;
    font-family: monospace;
    line-height: 1;
  }

  /* Palette Dialog */
  .cmd-palette {
    padding: 0;
    border: none;
    background: transparent;
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    position: fixed;
    inset: 0;
    z-index: 9999;
    
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
    
    background-color: rgba(0, 0, 0, 0.5); /* Mobile handling mainly */
    backdrop-filter: blur(4px);
    
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  .cmd-palette[open] {
    opacity: 1;
    pointer-events: auto;
  }

  .palette-container {
    width: 640px;
    max-width: 95%;
    background: linear-gradient(to bottom, #1f1f23, #18181b);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    box-shadow: 0 40px 80px -15px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255,255,255,0.05);
    overflow: hidden;
    transform: translateY(-10px) scale(0.98);
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
  }

  .cmd-palette[open] .palette-container {
    transform: translateY(0) scale(1);
  }

  /* Header */
  .palette-header {
    display: flex;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    gap: 0.75rem;
  }

  .search-icon-wrapper {
    color: var(--color-text-dim);
  }

  #palette-input {
    flex: 1;
    background: transparent;
    border: none;
    font-size: 1.1rem;
    color: var(--color-text-main);
    font-family: inherit;
    outline: none;
    height: 100%;
  }

  #palette-input::placeholder {
    color: var(--color-text-dim);
  }

  .keyboard-hints {
    display: flex;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
  
  .hint-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
  }

  /* Results */
  .palette-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.75rem;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
  }
  
  .palette-results::-webkit-scrollbar {
    width: 6px;
  }
  .palette-results::-webkit-scrollbar-thumb {
    background-color: rgba(255,255,255,0.1);
    border-radius: 3px;
  }

  /* Result Items */
  :global(.cmd-item) {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    color: var(--color-text-muted);
    text-decoration: none;
    cursor: pointer;
    transition: all 0.1s;
    border: 1px solid transparent;
    margin-bottom: 2px;
  }

  :global(.cmd-item:hover), :global(.cmd-item.selected) {
    background-color: rgba(255, 255, 255, 0.06);
    color: var(--color-text-main);
    border-color: rgba(255, 255, 255, 0.05);
  }

  :global(.cmd-item.selected) {
      border-left: 2px solid var(--color-primary);
  }

  :global(.cmd-icon-box) {
    width: 24px;
    height: 24px;
    border-radius: 4px; /* URL images might look better square-ish or round? */
    object-fit: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    background: rgba(255,255,255,0.05);
  }
  
  :global(.cmd-icon-box.img-icon) {
      background: transparent;
  }

  :global(.cmd-content) {
    flex: 1;
    min-width: 0;
  }

  :global(.cmd-title) {
    font-weight: 500;
    font-size: 0.95rem;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  :global(.cmd-title .highlight) {
      color: var(--color-primary);
      text-decoration: underline;
      background: rgba(139, 92, 246, 0.1);
  }

  :global(.cmd-meta) {
    font-size: 0.75rem;
    opacity: 0.6;
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  :global(.cmd-tag) {
    background: rgba(255,255,255,0.1);
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 0.65rem;
    text-transform: uppercase;
    font-weight: 700;
  }

  :global(.cmd-enter) {
    opacity: 0;
    transform: translateX(-5px);
    transition: all 0.2s;
  }
  
  :global(.cmd-item.selected .cmd-enter) {
      opacity: 1;
      transform: translateX(0);
  }

  /* Empty State */
  .empty-state {
    padding: 1rem;
    text-align: center;
    color: var(--color-text-dim);
  }
  
  .quick-actions {
      margin-top: 2rem;
      text-align: left;
  }
  
  .qa-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--color-text-muted);
      margin-bottom: 0.75rem;
      display: block;
  }
  
  .qa-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
  }
  
  .qa-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      color: var(--color-text-main);
      text-decoration: none;
      font-size: 0.9rem;
      transition: background 0.2s;
  }
  
  .qa-item:hover {
      background: rgba(255,255,255,0.08);
  }

  .palette-footer {
    padding: 0.5rem 1rem;
    background: rgba(0,0,0,0.2);
    border-top: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: var(--color-text-dim);
  }

  @media (max-width: 640px) {
      .cmd-btn .cmd-hint {
          display: none;
      }
      .palette-container {
          width: 100%;
          height: 100%;
          max-height: 100%;
          border-radius: 0;
          transform: none;
      }
      .cmd-palette {
          padding-top: 0;
      }
      .keyboard-hints {
          display: none;
      }
  }
</style>

<script>
  import Fuse from 'fuse.js';

  interface SearchItem {
    title: string;
    description: string;
    type: string;
    slug: string;
    image?: string;
    date: string;
  }

  let fuseInstance: Fuse<SearchItem> | undefined;
  let searchData: SearchItem[] = [];
  let selectedIndex = -1;

  function initCommandPalette() {
      const dialog = document.getElementById('cmd-palette') as HTMLDialogElement | null;
      const trigger = document.getElementById('cmd-palette-trigger');
      const input = document.getElementById('palette-input') as HTMLInputElement | null;
      const resultsContainer = document.getElementById('palette-results');
      const countEl = document.getElementById('results-count');
      
      if (!dialog || !trigger) return;

      let isOpen = false;

      // Initialize Search Data
      async function initSearch() {
        if (searchData.length > 0) return;

        try {
          const res = await fetch('/api/search.json');
          searchData = await res.json();
          
          fuseInstance = new Fuse(searchData, {
            keys: [
                { name: 'title', weight: 0.7 },
                { name: 'description', weight: 0.3 },
                { name: 'type', weight: 0.2 }
            ],
            threshold: 0.3,
            ignoreLocation: true,
          });
        } catch (e) {
          console.error('Error loading search data', e);
        }
      }

      function openPalette() {
        isOpen = true;
        dialog?.showModal();
        dialog?.addEventListener('click', onBackdropClick);
        document.body.style.overflow = 'hidden';
        initSearch(); 
        input?.focus();
        if(input && input.value) {
            handleInput({ target: input } as any);
        }
      }

      function closePalette() {
        isOpen = false;
        dialog?.close();
        dialog?.removeEventListener('click', onBackdropClick);
        document.body.style.overflow = '';
        selectedIndex = -1;
      }

      function onBackdropClick(e: MouseEvent) {
        if (e.target === dialog) {
            closePalette();
        }
      }

      function updateSelection(index: number) {
          const items = resultsContainer?.querySelectorAll('.cmd-item');
          if (!items) return;
          
          items.forEach(el => el.classList.remove('selected'));
          
          if (index >= 0 && index < items.length) {
              const selected = items[index] as HTMLElement;
              selected.classList.add('selected');
              selected.scrollIntoView({ block: 'nearest' });
          }
          selectedIndex = index;
      }

      function handleKeydown(e: KeyboardEvent) {
        // Global Open
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (isOpen) closePalette();
          else openPalette();
          return;
        }

        if (!isOpen) return;

        // Navigation
        const items = resultsContainer?.querySelectorAll('.cmd-item');
        const count = items?.length || 0;

        switch(e.key) {
           case 'ArrowDown':
               e.preventDefault();
               if(count > 0) updateSelection((selectedIndex + 1) % count);
               break;
           case 'ArrowUp':
               e.preventDefault();
               if(count > 0) updateSelection((selectedIndex - 1 + count) % count);
               break;
           case 'Enter':
               e.preventDefault();
               if (selectedIndex >= 0 && items && items[selectedIndex]) {
                   (items[selectedIndex] as HTMLElement).click();
               }
               break;
           case 'Escape':
               closePalette();
               break;
        }
      }
      
      function handleInput(e: Event) {
        const query = (e.target as HTMLInputElement).value;
        selectedIndex = 0; // Reset selection on new search
        
        if (!fuseInstance) return;

        if (query.length === 0) {
          // Show default/empty state
           if(resultsContainer) {
               resultsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="quick-actions">
                        <span class="qa-title">Navegaci√≥n</span>
                        <div class="qa-grid">
                        <a href="/episodes" class="qa-item"><span class="qa-icon">üéôÔ∏è</span> Ir a Episodios</a>
                        <a href="/equipo" class="qa-item"><span class="qa-icon">üë•</span> Ver Equipo</a>
                        <a href="/blog" class="qa-item"><span class="qa-icon">üìù</span> Leer Blog</a>
                        </div>
                    </div>
                </div>`;
                if(countEl) countEl.innerText = '';
           }
          return;
        }

        const results = fuseInstance.search(query);
        renderResults(results.map(r => r.item));
      }

      function renderResults(items: SearchItem[]) {
        if (!resultsContainer) return;
        
        if(countEl) countEl.innerText = `${items.length} resultados`;

        if (items.length === 0) {
            resultsContainer.innerHTML = `<div class="empty-state">No se encontraron resultados.</div>`;
            return;
        }

        resultsContainer.innerHTML = items.map((item, index) => {
             const isImage = item.image && item.image.startsWith('http') || item.image?.startsWith('/');
             return `
          <a href="${item.slug}" class="cmd-item ${index === 0 ? 'selected' : ''}" data-index="${index}">
            ${isImage 
                ? `<img src="${item.image}" class="cmd-icon-box img-icon" />` 
                : `<div class="cmd-icon-box">#</div>`
            }
            <div class="cmd-content">
              <span class="cmd-title">${item.title}</span>
              <div class="cmd-meta">
                <span class="cmd-tag">${item.type}</span>
                <span>${item.description ? item.description.substring(0, 40) + '...' : ''}</span>
              </div>
            </div>
            <div class="cmd-enter">‚Üµ</div>
          </a>
        `}).join('');
        
        // Add click listeners to new items
        const newItems = resultsContainer.querySelectorAll('.cmd-item');
        newItems.forEach(item => {
            item.addEventListener('click', () => {
                closePalette();
            });
            item.addEventListener('mouseenter', (e) => {
                const idx = parseInt((e.currentTarget as HTMLElement).dataset.index || '0');
                updateSelection(idx);
            });
        });
      }

      // Cleanup & Attach
      trigger.addEventListener('click', openPalette);
      input?.addEventListener('input', handleInput);
      document.addEventListener('keydown', handleKeydown);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initCommandPalette);
</script>
