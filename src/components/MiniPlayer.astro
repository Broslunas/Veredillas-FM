---
// src/components/MiniPlayer.astro
// Persisted player component that listens for 'play-episode' events
---

<!-- Mini Player (Floating) -->
<div id="mini-player" class="mini-player hidden">
  <div class="player-wrapper glass-panel">
      <div id="player-placeholder"></div>
      
      <!-- Controls for Mini Player -->
      <div class="mini-controls">

          <button id="expand-player" class="control-btn" aria-label="Pantalla completa">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
          </button>
          <button id="close-player" class="control-btn close" aria-label="Cerrar reproductor">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
      </div>
  </div>
</div>

<!-- Immersive Overlay (Cinema Mode) -->
<div id="immersive-player" class="immersive-overlay hidden">
    <div class="background-glow"></div>
    <div class="immersive-container">
        
        <div class="immersive-controls-top">

            <button id="collapse-player" class="icon-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
            </button>
        </div>

        <div class="immersive-content">
            <div class="immersive-cover-wrapper">
                <img id="immersive-cover" src="/logo.png" alt="Cover" />
                <div class="vinyl-grooves"></div>
            </div>
            
            <div class="immersive-meta">
                <h2 id="immersive-title">Título del Episodio</h2>
                <p id="immersive-author">Veredillas FM</p>
            </div>

            <canvas id="audio-visualizer"></canvas>
        </div>
    </div>
</div>

<!-- Hidden Story Card Template -->
<!-- Story Customization Modal -->


<script>
    import { FastAverageColor } from 'fast-average-color';
    // @ts-ignore


    declare global {
        interface Window {
            hasGlobalPlayerListener: boolean;
            playerCurrentUrl: string | null;
            playerMeta: { title: string, image: string, author: string } | null;
            visualizerInterval: number;
        }
    }

    // We use a global flag to prevent attaching GLOBAL event listeners (like 'play-episode' on document) multiple times.
    // However, 'astro:page-load' needs to be handled carefully.

        window.playerCurrentUrl = null;
        window.playerMeta = null;
        
        // Modules are cached, so these run once.
        const fac = new FastAverageColor();

        // ---- Visualizer Logic (Simulated) ----
        const initVisualizer = () => {
             const canvas = document.getElementById('audio-visualizer') as HTMLCanvasElement;
             if (!canvas) return;
             
             const ctx = canvas.getContext('2d');
             if (!ctx) return;

             // Resize
             const resize = () => {
                 canvas.width = canvas.offsetWidth;
                 canvas.height = canvas.offsetHeight;
             };
             window.addEventListener('resize', resize);
             resize();

             if (window.visualizerInterval) cancelAnimationFrame(window.visualizerInterval);

             const bars = 60;
             let time = 0;

             const draw = () => {
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
                 
                 const width = canvas.width / bars;
                 const center = canvas.height / 2;
                 
                 ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
                 
                 for (let i = 0; i < bars; i++) {
                     // Simulating wave data based on time and index
                     const relX = i / bars; // 0 to 1
                     
                     // Complex wave function to look like speech/music
                     const h1 = Math.sin(time * 0.1 + i * 0.2) * 50; 
                     const h2 = Math.cos(time * 0.2 + i * 0.1) * 30;
                     const noise = Math.random() * 20;
                     
                     // Shape envelope (taper at ends)
                     const envelope = Math.sin(relX * Math.PI);
                     
                     const height = Math.abs((h1 + h2 + noise) * envelope * 2); // Scale up
                     
                     const x = i * width;
                     const y = center - height / 2;
                     
                     // Rounded bars
                     ctx.beginPath();
                     ctx.roundRect(x + 2, y, width - 4, height, 4);
                     ctx.fill();
                 }
                 
                 time += 0.5;
                 window.visualizerInterval = requestAnimationFrame(draw);
             };
             
             draw();
        };

        // ---- Ambient Mode Logic ----
        const updateAmbientTheme = async (imageUrl: string) => {
            try {
                const color = await fac.getColorAsync(imageUrl);
                document.documentElement.style.setProperty('--color-primary-glow', color.rgba);
                // Also update the glow in immersive mode
                const glow = document.querySelector('.background-glow') as HTMLElement;
                if (glow) {
                    glow.style.background = `radial-gradient(circle at center, ${color.rgba}, transparent 70%)`;
                }
            } catch (e) {
                console.log("Ambient color failed", e);
            }
        };

        const setupCustomPlayer = (container: HTMLElement, url: string, title: string, cover: string, author: string) => {
             // 1. Inject HTML
             container.innerHTML = `
<div class="custom-audio-player">
  <div class="player-card" id="customPlayerCard">
    <div class="visualizer-container">
      <canvas id="audioVisualizer" width="300" height="100"></canvas>
    </div>
    <div class="cover-image">
      ${cover ? `<img src="${cover}" alt="${title}" />` : `
        <div class="cover-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163z" />
          </svg>
        </div>
      `}
    </div>

    <div class="player-content">
      <div class="track-info">
        <h2>${title}</h2>
        <p>${author}</p>
      </div>

      <div class="progress-section">
        <input type="range" id="seekBar" value="0" step="0.1" />
      </div>
    </div>
    
    <div class="controls-row">
        <div class="main-controls">
           <button id="backwardBtn" class="secondary-control" aria-label="Retroceder 15s">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-6 6m0 0l-6-6m6 6V9a6 6 0 0112 0v3" />
            </svg>
          </button>

          <button id="playPauseBtn" class="play-pause-btn" aria-label="Reproducir/Pausar">
            <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
              <path d="M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393" />
            </svg>
            <svg id="iconPause" class="hidden icon-pause" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
              <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5m5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.A 1.5 0 0 1 10.5 3.5" />
            </svg>
            <svg id="iconLoading" class="hidden spinner" viewBox="0 0 50 50">
              <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
          </button>
          
           <button id="forwardBtn" class="secondary-control" aria-label="Avanzar 15s">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 15l6 6m0 0l6-6m-6 6V9a6 6 0 00-12 0v3" />
            </svg>
          </button>
        </div>

        <div class="volume-controls">
           <button id="speedBtn" class="speed-btn">1x</button>
           <div class="volume-slider-container">
             <input type="range" id="volumeBar" min="0" max="1" step="0.05" value="1" />
           </div>
        </div>
    </div>
  </div>
   <audio id="audioElement" src="${url}" preload="metadata" crossorigin="anonymous"></audio>
</div>
             `;

             // 2. Attach Logic (Simplified from audioPlayer.ts)
             const audio = container.querySelector('#audioElement') as HTMLAudioElement;
             const playBtn = container.querySelector('#playPauseBtn') as HTMLElement;
             const backBtn = container.querySelector('#backwardBtn') as HTMLElement;
             const fwdBtn = container.querySelector('#forwardBtn') as HTMLElement;
             const seekBar = container.querySelector('#seekBar') as HTMLInputElement;
             const volumeBar = container.querySelector('#volumeBar') as HTMLInputElement;
             const speedBtn = container.querySelector('#speedBtn') as HTMLElement;
             
             const iconPlay = container.querySelector('#iconPlay');
             const iconPause = container.querySelector('#iconPause');
             const iconLoading = container.querySelector('#iconLoading');
             
             const speeds = [1, 1.25, 1.5, 2, 0.75];
             let speedIdx = 0;

             // State updates
             const updateIcons = () => {
                 if(iconLoading && !iconLoading.classList.contains('hidden')) return;
                 if(audio.paused) {
                     iconPlay?.classList.remove('hidden');
                     iconPause?.classList.add('hidden');
                 } else {
                     iconPlay?.classList.add('hidden');
                     iconPause?.classList.remove('hidden');
                 }
             };

             // Listeners
             playBtn.onclick = () => {
                 if(audio.paused) audio.play();
                 else audio.pause();
             };
             
             backBtn.onclick = () => audio.currentTime = Math.max(0, audio.currentTime - 15);
             fwdBtn.onclick = () => audio.currentTime = Math.min(audio.duration, audio.currentTime + 15);
             
             seekBar.oninput = () => {
                 audio.currentTime = parseFloat(seekBar.value);
             }
             
             const updateSeek = () => {
                  if(document.activeElement !== seekBar) {
                      seekBar.value = audio.currentTime.toString();
                  }
                  // Visualizer Draw call loop is separate
             };

             volumeBar.oninput = () => {
                 audio.volume = parseFloat(volumeBar.value);
             }
             
             speedBtn.onclick = () => {
                 speedIdx = (speedIdx + 1) % speeds.length;
                 const s = speeds[speedIdx];
                 audio.playbackRate = s;
                 speedBtn.innerText = `${s}x`;
             }

             // Audio events
             audio.ontimeupdate = updateSeek;
             
             audio.onloadedmetadata = () => {
                 seekBar.max = audio.duration.toString();
                 iconLoading?.classList.add('hidden');
                 updateIcons();
             };
             
             audio.onwaiting = () => {
                 iconPlay?.classList.add('hidden');
                 iconPause?.classList.add('hidden');
                 iconLoading?.classList.remove('hidden');
             };
             
             audio.onplaying = () => {
                 iconLoading?.classList.add('hidden');
                 updateIcons();
                 initVisualizer(); 
             };
             
             audio.onplay = updateIcons;
             audio.onpause = updateIcons;
             
             // Error Handling & CORS Fallback
             audio.onerror = (e) => {
                 const error = audio.error;
                 console.warn("Audio Error:", error);
                 if (error && (error.code === MediaError.MEDIA_ERR_NETWORK || error.code === MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED)) {
                     if (audio.hasAttribute("crossorigin")) {
                         console.info("CORS or Network error detected. Falling back to standard playback without Visualizer.");
                         // Remove crossorigin to allow opaque response (no visualizer, but plays)
                         audio.removeAttribute("crossorigin");
                         audio.load();
                         // The visualizer will fail gracefully in initVisualizer
                         if(playBtn) playBtn.click(); // Auto-resume if it was trying to play
                     }
                 }
             };
             
             // Visualizer (Simple version)
             let audioCtx: AudioContext;
             let analyser: AnalyserNode;
             let source: MediaElementAudioSourceNode;
             let canvas = container.querySelector('#audioVisualizer') as HTMLCanvasElement;
             
             const initVisualizer = () => {
                 // Check if we are allowed to visualize (CORS)
                 if (!audio.crossOrigin) return;

                 if(!audioCtx) {
                      const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
                      audioCtx = new AudioContext();
                      try {
                          source = audioCtx.createMediaElementSource(audio);
                          analyser = audioCtx.createAnalyser();
                          analyser.fftSize = 64;
                          source.connect(analyser);
                          analyser.connect(audioCtx.destination);
                          draw();
                      } catch(e) {
                          console.log("Audio Context Error (likely CORS):", e);
                      }
                 } else if (audioCtx.state === 'suspended') {
                     audioCtx.resume();
                 }
             };
             
             const draw = () => {
                 if(!canvas || !analyser) return;
                 const ctx = canvas.getContext('2d');
                 if(!ctx) return;
                 const bufferLength = analyser.frequencyBinCount;
                 const dataArray = new Uint8Array(bufferLength);
                 
                 const renderFrame = () => {
                     if(audio.paused) return; // Stop drawing to save resources
                     requestAnimationFrame(renderFrame);
                     ctx.clearRect(0,0, canvas.width, canvas.height);
                     
                     if (!analyser) return; // Safeguard if CORS/AudioCtx failed
                     try {
                        analyser.getByteFrequencyData(dataArray);
                     } catch(e) { return ; }

                     const barWidth = (canvas.width / bufferLength) * 2;
                     let x = 0;
                     ctx.fillStyle = 'rgba(255,255,255,0.3)';
                     
                     for(let i=0; i<bufferLength; i++) {
                         const barHeight = dataArray[i] / 2;
                         ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                         x += barWidth + 1;
                     }
                 };
                 renderFrame();
             };
             
             // Apply dynamic background
             if(cover) {
                 fac.getColorAsync(cover).then(color => {
                     const card = container.querySelector('#customPlayerCard') as HTMLElement;
                     if(card) {
                         // Use a nice gradient mixing the extracted color
                         card.style.background = `linear-gradient(145deg, ${color.rgba} 0%, rgba(15, 23, 42, 0.95) 100%)`;
                     }
                 }).catch(e => console.log(e));
             }
        };

        // Function to update position and metadata
        const updatePlayerState = () => {
            const player = document.getElementById('mini-player');
            const placeholder = document.getElementById('episode-player-placeholder');
            const container = document.getElementById('player-placeholder');
            const immersiveOverlay = document.getElementById('immersive-player');
            
            // Elements to update in Immersive
            const immTitle = document.getElementById('immersive-title');
            const immAuthor = document.getElementById('immersive-author');
            const immCover = document.getElementById('immersive-cover') as HTMLImageElement;

            if (!player || !container) return;

            if (placeholder) {
                // INLINE MODE CANDIDATE
                const spotifyUrl = placeholder.getAttribute('data-spotify-url');
                const audioUrl = placeholder.getAttribute('data-audio-url');
                const url = spotifyUrl || audioUrl;
                const title = placeholder.getAttribute('data-title');
                const image = placeholder.getAttribute('data-image');
                const author = placeholder.getAttribute('data-author');

                // Update Meta Global
                if (title) window.playerMeta = { title, image: image || '/logo.png', author: author || 'Veredillas FM' };

                // CHECK CONFLICT
                if (window.playerCurrentUrl && url && window.playerCurrentUrl !== url) {
                    // CONFLICT: Show Floating Player
                    if (container.hasChildNodes()) {
                        player.classList.remove('inline', 'hidden');
                        player.classList.add('floating', 'visible');
                        
                        // Setup Floating Styles
                        player.style.position = 'fixed';
                        player.style.top = 'auto';
                        player.style.bottom = '0';
                        player.style.left = '0';
                        player.style.width = '100%';
                        player.style.height = 'auto';
                        
                        const closeBtn = document.getElementById('close-player');
                        if(closeBtn) closeBtn.style.display = 'flex';
                        
                        document.body.style.paddingBottom = '100px';
                        
                        // Populate Immersive if needed
                        if (immTitle && window.playerMeta) {
                            immTitle.innerText = window.playerMeta.title;
                            if (immAuthor) immAuthor.innerText = window.playerMeta.author;
                            immCover.src = window.playerMeta.image;
                            updateAmbientTheme(window.playerMeta.image);
                        }
                    }

                    // Render Prompt in Placeholder
                    if (!placeholder.hasAttribute('data-rendered-prompt')) {
                         placeholder.setAttribute('data-rendered-prompt', 'true');
                         placeholder.innerHTML = `
                            <div class="conflict-wrapper" style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; background: rgba(255,255,255,0.03); border-radius:12px; border: 1px dashed rgba(255,255,255,0.1);">
                                <p style="margin:0; color: #a1a1aa; font-size: 0.95rem; font-weight: 500;">Estás escuchando otro episodio</p>
                                <button id="force-play-btn" style="cursor: pointer; background: white; color: black; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
                                    Reproducir este en su lugar
                                </button>
                            </div>
                        `;
                        
                        const btn = placeholder.querySelector('#force-play-btn');
                        if(btn) {
                            btn.addEventListener('click', () => {
                                window.playerCurrentUrl = null; 
                                container.innerHTML = '';
                                updatePlayerState();
                            });
                        }
                    }
                    return; 
                }
                
                // NO CONFLICT -> Inline Logic
                if (url && (window.playerCurrentUrl !== url)) {
                    window.playerCurrentUrl = url;
                    if(title) window.playerMeta = { title, image: image || '/logo.png', author: author || 'Veredillas FM' };
                    
                    // Update Ambient
                    if (image) updateAmbientTheme(image);
                    
                    if (spotifyUrl) {
                        // Inject Iframe
                        let finalUrl = url;
                        try {
                             const urlObj = new URL(url);
                             if (!urlObj.pathname.includes('/embed/')) {
                                  const segments = urlObj.pathname.split('/').filter(Boolean);
                                  if (segments[0] !== 'embed') finalUrl = `${urlObj.origin}/embed${urlObj.pathname}`;
                             }
                        } catch(e) {}
                        
                        container.innerHTML = `
                            <iframe 
                            id="spotify-iframe"
                            style="border-radius:12px" 
                            src="${finalUrl}?autoplay=0" 
                            width="100%" 
                            height="100%" 
                            frameBorder="0"
                            scrolling="no"
                            allowfullscreen="" 
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                            loading="lazy">
                        </iframe>
                        `;
                    } else if (audioUrl) {
                        setupCustomPlayer(container, audioUrl, title || 'Episodio', image || '/logo.png', author || 'Veredillas FM');
                    }
                }

                // Inline CSS
                const rect = placeholder.getBoundingClientRect();
                const scrollX = window.scrollX || window.pageXOffset;
                const scrollY = window.scrollY || window.pageYOffset;

                player.classList.remove('floating', 'hidden');
                player.classList.add('inline', 'visible');

                player.style.position = 'absolute';
                player.style.top = `${rect.top + scrollY}px`;
                player.style.left = `${rect.left + scrollX}px`;
                player.style.width = `${rect.width}px`;
                player.style.height = `${rect.height}px`;
                
                // Hide controls in inline
                const ctrls = player.querySelector('.mini-controls') as HTMLElement;
                if(ctrls) ctrls.style.display = 'none';

                document.body.style.paddingBottom = '0';

            } else {
                // FLOATING MODE (Navigating other pages)
                if (container.hasChildNodes()) {
                    player.classList.remove('inline', 'hidden');
                    player.classList.add('floating', 'visible');

                    player.style.position = 'fixed';
                    player.style.top = 'auto';
                    player.style.bottom = '0';
                    player.style.left = '0';
                    player.style.width = '100%';
                    player.style.height = 'auto';

                    const ctrls = player.querySelector('.mini-controls') as HTMLElement;
                    if(ctrls) ctrls.style.display = 'flex';

                    document.body.style.paddingBottom = '100px';

                    // Update Immersive Data if available
                    if (window.playerMeta && immTitle) {
                         immTitle.innerText = window.playerMeta.title;
                         if (immAuthor) immAuthor.innerText = window.playerMeta.author;
                         immCover.src = window.playerMeta.image;
                         updateAmbientTheme(window.playerMeta.image);
                    }
                } else {
                    player.classList.add('hidden');
                    player.classList.remove('visible');
                    document.body.style.paddingBottom = '0';
                }
            }
        };

        // Listeners

        window.addEventListener('resize', updatePlayerState);
        
        // Custom Play Event
        document.addEventListener('play-episode', ((e: Event) => {
             const customEvent = e as CustomEvent;
             const { url, title, image, author } = customEvent.detail;
             
             const container = document.getElementById('player-placeholder');
             
             if (container) {
                 window.playerCurrentUrl = url;
                 if (title) window.playerMeta = { title, image, author };
                 
                 // Reuse insertion logic
                 // ... simplified for brevity, assume updatePlayerState handles if we set the placeholder attrs conceptually or just direct
                 // Since we don't have a placeholder on non-ep pages, we must manually inject into floating
                 // But wait, play-episode usually comes from clicking something.
                 // If we are on a listing page, there is no placeholder.
                 
                 // Direct Inject
                 if (url.includes('spotify.com')) {
                     let finalUrl = url;
                     try {
                         const urlObj = new URL(url);
                         if (!urlObj.pathname.includes('/embed/')) {
                              const segments = urlObj.pathname.split('/').filter(Boolean);
                              if (segments[0] !== 'embed') finalUrl = `${urlObj.origin}/embed${urlObj.pathname}`;
                         }
                     } catch(e) {}

                     container.innerHTML = `
                         <iframe 
                             id="spotify-iframe"
                             style="border-radius:12px" 
                             src="${finalUrl}?autoplay=1" 
                             width="100%" 
                             height="100%" 
                             frameBorder="0" 
                             scrolling="no"
                             allowfullscreen="" 
                             allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                             loading="lazy">
                         </iframe>
                     `;
                 } else {
                     setupCustomPlayer(container, url, title || 'Episodio', image || '/logo.png', author || 'Veredillas FM');
                 }
                  
                  if(image) updateAmbientTheme(image);
                  updatePlayerState();
             }
        }));

        // Custom Share Story Event


        // Modal Listeners


        // Close logic
         document.addEventListener('click', (e: Event) => {
            const target = e.target as HTMLElement;
            if (target && target.closest('#close-player')) {
                const player = document.getElementById('mini-player');
                const container = document.getElementById('player-placeholder');
                if (player) {
                    player.classList.remove('visible');
                    document.body.style.paddingBottom = '0';
                    setTimeout(() => {
                        player.classList.add('hidden');
                        if (container) container.innerHTML = '';
                        window.playerCurrentUrl = null;
                        window.playerMeta = null;
                        // Close immersive if open
                        document.getElementById('immersive-player')?.classList.add('hidden');
                    }, 300);
                }
            }
            
            // Expand
            if (target && target.closest('#expand-player')) {
                const immersive = document.getElementById('immersive-player');
                if (immersive) {
                    immersive.classList.remove('hidden');
                    initVisualizer();
                }
            }

            // Collapse
            if (target && target.closest('#collapse-player')) {
                 const immersive = document.getElementById('immersive-player');
                 if (immersive) immersive.classList.add('hidden');
            }


        });



    
    // Auto-run setup (MPA mode)
    document.addEventListener('DOMContentLoaded', updatePlayerState);
</script>

<style>
  .mini-player {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 9999;
    padding: 0;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  .mini-player.hidden {
      display: none;
      transform: translateY(120%);
  }
  
  .mini-player.visible {
      display: block;
      transform: translateY(0);
  }

  .player-wrapper {
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
  }
  
  .mini-player.floating .player-wrapper {
       max-width: 600px;
       margin: 0 auto 10px; /* margin bottom for floating */
       height: 152px !important;
       border: 1px solid rgba(255,255,255,0.1);
  }

  .mini-controls {
      position: absolute;
      top: 5px;
      right: 5px;
      display: none; /* Hidden by default (inline) */
      gap: 5px;
      z-index: 20;
  }

  .control-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: all 0.2s;
  }

  .control-btn:hover {
      background: white;
      color: black;
  }

  /* Inline Specifics */
  .mini-player.inline {
      padding: 0;
      z-index: 10; 
      box-shadow: none;
  }
  .mini-player.inline .player-wrapper {
      background: transparent;
      box-shadow: none;
      border: none;
      max-width: none;
      border-radius: 12px;
      height: 100%;
  }

  #player-placeholder {
      width: 100%;
      height: 100%;
  }
  
  :global(#spotify-iframe) {
      width: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
      border: none !important;
  }

  /* IMMERSIVE MODE */
  .immersive-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: #050505;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
  }

  .immersive-overlay:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
  }

  .immersive-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
  }

  .background-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at center, var(--color-primary-glow), transparent 70%);
      opacity: 0.3;
      z-index: 1;
      pointer-events: none;
  }

  .immersive-content {
      text-align: center;
      width: 100%;
      max-width: 500px;
      padding: 20px;
  }

  .immersive-cover-wrapper {
      width: 300px;
      height: 300px;
      margin: 0 auto 30px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      position: relative;
      animation: float 6s ease-in-out infinite;
  }

  .immersive-cover-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }

  .immersive-meta h2 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(to bottom, #fff, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
  }
  
  .immersive-meta p {
      font-size: 1.2rem;
      color: var(--color-text-muted);
      margin-bottom: 2rem;
  }

  #audio-visualizer {
      width: 100%;
      height: 100px;
      margin-top: 20px;
      opacity: 0.8;
  }

  .collapse-btn {
      position: absolute;
      top: 40px;
      right: 40px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 10;
  }
  
  .collapse-btn:hover {
      background: rgba(255,255,255,0.2);
  }
</style>

<style>


  /* Immersive Top Controls */
  .immersive-controls-top {
      position: absolute;
      top: 40px;
      right: 40px;
      display: flex;
      gap: 15px;
      z-index: 10;
  }

  .icon-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
  }
  
  .icon-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
  }

</style>

<style is:global>
  /* --- Custom Audio Player Styles (Ported from AudioPlayer.astro) --- */
  .custom-audio-player {
    font-family: "Inter", sans-serif;
    width: 100%;
    height: 100%; /* Adapting to MiniPlayer container */
    max-width: 800px;
    margin: 0 auto;
  }

  .player-card {
    display: flex;
    gap: 20px; /* Reduced gap */
    padding: 16px; /* Reduced padding */
    border-radius: 12px; /* Matches MiniPlayer */
    background: linear-gradient(145deg, rgba(30, 58, 138, 0.9), rgba(15, 23, 42, 0.95));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    position: relative;
    overflow: hidden;
    height: 100%;
    align-items: center;
  }
  
  /* Make sure it fits in the floating player */
  .mini-player.floating .player-card {
      padding: 12px 20px;
  }

  /* --- Carátula --- */
  .cover-image {
    width: 80px; /* Smaller for MiniPlayer */
    height: 80px;
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    background-color: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
  }

  .cover-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .cover-placeholder {
    color: rgba(255, 255, 255, 0.3);
    width: 32px;
    height: 32px;
  }

  /* --- Contenido del Reproductor (Derecha) --- */
  .player-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 8px; /* Reduced gap */
    position: relative;
    z-index: 1;
    min-width: 0; /* Fix flex overflow */
  }

  /* --- Info Pista --- */
  .track-info h2 {
    font-size: 1rem;
    font-weight: 700;
    margin: 0 0 4px 0;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .track-info p {
    font-size: 0.85rem;
    color: #94a3b8;
    margin: 0;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* --- Visualizer --- */
  .visualizer-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    opacity: 0.2; /* Subtle */
  }

  #audioVisualizer {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
  }

  /* --- Barra de Progreso --- */
  .progress-section {
    width: 100%;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .time-labels {
      display: none; 
  }
  
  .time-display {
      font-size: 0.75rem;
      color: #cbd5e1;
      font-variant-numeric: tabular-nums;
      min-width: 35px;
  }

  /* Slider común */
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
    width: 100%;
    display: block;
  }

  /* Track Progreso */
  #seekBar {
    height: 4px;
    flex-grow: 1;
  }

  #seekBar::-webkit-slider-runnable-track {
    background-color: rgba(255, 255, 255, 0.2);
    height: 4px;
    border-radius: 2px;
  }

  #seekBar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    margin-top: -4px; 
    width: 12px;
    height: 12px;
    background-color: white;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
  }

  /* --- Controles Inferiores --- */
  .controls-row {
    display: flex;
    align-items: center;
    gap: 16px;
    /* margin-top: 4px; */
  }

  .main-controls {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .play-pause-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: white;
    color: #1e3a8a;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .play-pause-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
  }

  .play-pause-btn svg {
    width: 20px;
    height: 20px;
  }
  
  .play-pause-btn svg.icon-pause {
      margin-left: 0;
  }
  
  .play-pause-btn svg:not(.icon-pause):not(.spinner) {
      margin-left: 2px; /* Ajuste visual para el icono de play */
  }

  .secondary-control {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.2s ease;
  }

  .secondary-control:hover {
    background-color: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
  }

  .secondary-control svg {
    width: 16px;
    height: 16px;
  }
  
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* --- Volumen --- */
  .volume-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto; 
  }

  .volume-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }

  .volume-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .speed-btn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 0.75rem;
    font-weight: 600;
    font-variant-numeric: tabular-nums; 
  }

  .speed-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .volume-slider-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 60px; /* Specific width */
  }

  #volumeBar {
    width: 100%;
    height: 4px;
  }

  #volumeBar::-webkit-slider-runnable-track {
    background-color: rgba(255, 255, 255, 0.2);
    height: 4px;
    border-radius: 2px;
  }

  #volumeBar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    margin-top: -4px;
    width: 12px;
    height: 12px;
    background-color: white;
    border-radius: 50%;
  }

  .hidden {
    display: none !important;
  }
  
  /* Spinner */
  .spinner {
    animation: rotate 2s linear infinite;
    width: 20px;
    height: 20px;
  }
  
  .spinner .path {
    stroke: #1e3a8a;
    stroke-linecap: round;
    animation: dash 1.5s ease-in-out infinite;
  }
  
  @keyframes rotate {
    100% {
      transform: rotate(360deg);
    }
  }
  
  @keyframes dash {
    0% {
      stroke-dasharray: 1, 150;
      stroke-dashoffset: 0;
    }
    50% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -35;
    }
    100% {
      stroke-dasharray: 90, 150;
      stroke-dashoffset: -124;
    }
  }

  /* Responsive Adjustments for MiniPlayer context */
  @media (max-width: 768px) {
      .player-card {
          padding: 12px;
          gap: 12px;
      }
      
      .cover-image {
          width: 60px;
          height: 60px;
      }
      
      .volume-slider-container {
          display: none;
      }
      
      .controls-row {
          gap: 8px;
      }
      
      .main-controls {
          gap: 8px;
      }
      
      .play-pause-btn {
          width: 36px;
          height: 36px;
      }
      
      .secondary-control {
          background: transparent; /* Cleaner on mobile */
      }
  }
</style>


