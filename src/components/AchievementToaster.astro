---
// AchievementToaster.astro ‚Äî Global achievement unlock notifications
---

<!-- ‚îÄ‚îÄ Unlock Toast Overlay ‚îÄ‚îÄ -->
<div id="unlock-overlay" class="unlock-overlay hidden" aria-live="assertive" aria-atomic="true">
  <div class="unlock-toast" id="unlock-toast">
    <div class="toast-shimmer"></div>
    <div class="toast-top-bar">
      <span class="toast-eyebrow">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        ¬°Logro desbloqueado!
      </span>
      <button class="toast-close" id="toast-close" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="toast-body">
      <div class="toast-icon-wrap" id="toast-icon-wrap">
        <span class="toast-icon" id="toast-icon">üèÖ</span>
      </div>
      <div class="toast-info">
        <strong class="toast-name" id="toast-name">Cargando...</strong>
        <span class="toast-desc" id="toast-desc"></span>
        <span class="toast-rarity-badge" id="toast-rarity">Com√∫n</span>
      </div>
    </div>
    <div class="toast-progress-bar" id="toast-progress-bar"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Confetti Canvas ‚îÄ‚îÄ -->
<canvas id="confetti-canvas" class="confetti-canvas" aria-hidden="true"></canvas>

<style is:global>
  .unlock-overlay {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 9999;
    pointer-events: none;
    width: 340px;
    max-width: calc(100vw - 2rem);
  }

  .unlock-overlay.hidden { display: none; }

  .unlock-toast {
    position: relative;
    background: rgba(8, 8, 14, 0.95);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 20px;
    overflow: hidden;
    pointer-events: all;
    animation: toastSlideIn 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) both;
  }

  @keyframes toastSlideIn {
    from { transform: translateX(120%) scale(0.85); opacity: 0; }
    to   { transform: translateX(0)    scale(1);    opacity: 1; }
  }

  .toast-shimmer {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 30% 100%, var(--toast-color, #7c3aed) 0%, transparent 65%);
    opacity: 0.22;
    pointer-events: none;
  }

  .toast-top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.7rem 1rem 0;
    position: relative;
  }

  .toast-eyebrow {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-weight: 700;
    color: var(--toast-color, #a78bfa);
  }

  .toast-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.4);
    font-size: 0.85rem;
    cursor: pointer;
    padding: 0 0.25rem;
    line-height: 1;
    transition: color 0.15s;
  }

  .toast-close:hover { color: white; }

  .toast-body {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem 1rem;
    position: relative;
  }

  .toast-icon-wrap {
    width: 58px;
    height: 58px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.2rem;
    background: color-mix(in srgb, var(--toast-color, #7c3aed) 18%, transparent);
    border: 1px solid color-mix(in srgb, var(--toast-color, #7c3aed) 35%, transparent);
    flex-shrink: 0;
    animation: toastIconBounce 0.6s cubic-bezier(0.34,1.56,0.64,1) 0.2s both;
  }

  @keyframes toastIconBounce {
    from { transform: scale(0) rotate(-25deg); }
    to   { transform: scale(1) rotate(0deg); }
  }

  .toast-info {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    flex: 1;
    min-width: 0;
  }

  .toast-name {
    font-size: 1rem;
    font-weight: 800;
    color: var(--color-text, #f0f0f0);
    line-height: 1.2;
    display: block;
  }

  .toast-desc {
    font-size: 0.75rem;
    color: var(--color-text-muted, rgba(255,255,255,0.5));
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .toast-rarity-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.15rem 0.5rem;
    border-radius: 50px;
    background: color-mix(in srgb, var(--toast-color, #7c3aed) 20%, transparent);
    color: var(--toast-color, #a78bfa);
    border: 1px solid color-mix(in srgb, var(--toast-color, #7c3aed) 35%, transparent);
    width: fit-content;
    margin-top: 0.1rem;
  }

  .toast-progress-bar {
    height: 3px;
    background: linear-gradient(90deg, var(--toast-color, #7c3aed), transparent);
    animation: toastTimer 4s linear forwards;
    transform-origin: left;
  }

  @keyframes toastTimer {
    from { transform: scaleX(1); }
    to   { transform: scaleX(0); }
  }

  .confetti-canvas {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9998;
    display: none;
  }

  @media (max-width: 480px) {
    .unlock-overlay { bottom: 1rem; right: 1rem; width: calc(100vw - 2rem); }
  }
</style>

<script>
class Particle {
  x: number; y: number; r: number;
  color: string; vx: number; vy: number;
  alpha: number; decay: number;
  tilt: number; tiltSpeed: number;
  shape: 'circle' | 'rect' | 'star' | 'ribbon';

  constructor(w: number) {
    this.x = Math.random() * w;
    this.y = Math.random() * -50 - 10;
    this.r = Math.random() * 7 + 3;
    const h = Math.random() * 360;
    this.color = `hsl(${h},90%,65%)`;
    this.vx = (Math.random() - 0.5) * 7;
    this.vy = Math.random() * 3 + 2;
    this.alpha = 1;
    this.decay = 0.006 + Math.random() * 0.008;
    this.tilt = Math.random() * Math.PI * 2;
    this.tiltSpeed = (Math.random() - 0.5) * 0.18;
    const shapes = ['circle','rect','star','ribbon'] as const;
    this.shape = shapes[Math.floor(Math.random() * shapes.length)];
  }

  update() {
    this.x  += this.vx;
    this.y  += this.vy;
    this.vy += 0.1;
    this.vx *= 0.998;
    this.tilt += this.tiltSpeed;
    this.alpha -= this.decay;
  }

  draw(ctx: CanvasRenderingContext2D) {
    ctx.save();
    ctx.globalAlpha = Math.max(0, this.alpha);
    ctx.fillStyle = this.color;
    ctx.translate(this.x, this.y);
    ctx.rotate(this.tilt);

    if (this.shape === 'circle') {
      ctx.beginPath();
      ctx.arc(0, 0, this.r, 0, Math.PI * 2);
      ctx.fill();
    } else if (this.shape === 'rect') {
      ctx.fillRect(-this.r, -this.r * 0.5, this.r * 2, this.r);
    } else if (this.shape === 'ribbon') {
      ctx.fillRect(-this.r * 0.4, -this.r * 1.5, this.r * 0.8, this.r * 3);
    } else {
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const a = (i * 4 * Math.PI) / 5 - Math.PI / 2;
        if (i === 0) ctx.moveTo(this.r * Math.cos(a), this.r * Math.sin(a));
        else          ctx.lineTo(this.r * Math.cos(a), this.r * Math.sin(a));
      }
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }
}

let particles: Particle[] = [];
let raf: number | null = null;

function launchConfetti(ms = 2500) {
  const canvas = document.getElementById('confetti-canvas') as HTMLCanvasElement;
  if (!canvas) return;
  canvas.style.display = 'block';
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d')!;
  const endSpawn = Date.now() + ms * 0.5;

  function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (Date.now() < endSpawn) {
      for (let i = 0; i < 8; i++) particles.push(new Particle(canvas.width));
    }
    particles = particles.filter(p => p.alpha > 0 && p.y < canvas.height + 40);
    for (const p of particles) { p.update(); p.draw(ctx); }
    if (particles.length) {
      raf = requestAnimationFrame(loop);
    } else {
      canvas.style.display = 'none';
    }
  }
  if (raf) cancelAnimationFrame(raf);
  particles = [];
  loop();
}

interface ToastItem { name: string; desc: string; icon: string; rarity: string; color: string; }
const toastQ: ToastItem[] = [];
let toastActive = false;
let toastTimer: ReturnType<typeof setTimeout> | null = null;

function showNextToast() {
  if (toastActive || toastQ.length === 0) return;
  const t = toastQ.shift()!;
  toastActive = true;

  const overlay   = document.getElementById('unlock-overlay')!;
  const toast     = document.getElementById('unlock-toast')!;
  const iconWrap  = document.getElementById('toast-icon-wrap')!;
  const iconEl    = document.getElementById('toast-icon')!;
  const nameEl    = document.getElementById('toast-name')!;
  const descEl    = document.getElementById('toast-desc')!;
  const rarityEl  = document.getElementById('toast-rarity')!;
  const progBar   = document.getElementById('toast-progress-bar')!;

  toast.style.setProperty('--toast-color', t.color);
  iconWrap.style.setProperty('--toast-color', t.color);
  iconEl.textContent    = t.icon;
  nameEl.textContent    = t.name;
  descEl.textContent    = t.desc;
  rarityEl.textContent  = t.rarity;
  rarityEl.style.setProperty('--toast-color', t.color);

  progBar.style.animation = 'none';
  progBar.offsetHeight;
  progBar.style.animation = '';

  overlay.classList.remove('hidden');

  const isHeavy = ['√âpico','Legendario'].includes(t.rarity);
  launchConfetti(isHeavy ? 3500 : 1800);

  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(dismissToast, 4200);
}

function dismissToast() {
  const overlay = document.getElementById('unlock-overlay');
  if (overlay) overlay.classList.add('hidden');
  toastActive = false;
  if (toastTimer) clearTimeout(toastTimer);
  setTimeout(showNextToast, 300);
}

document.getElementById('toast-close')?.addEventListener('click', dismissToast);

function queueAchievementToast(item: ToastItem) {
  toastQ.push(item);
  showNextToast();
}

// Global functions
(window as any).queueAchievementToast = queueAchievementToast;

(window as any).unlockAchievement = async (achievementId: string) => {
  try {
    const res = await fetch('/api/achievements/unlock', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ achievementId }),
    });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.alreadyHad && data.achievement) {
      const a = data.achievement;
      const colorMap: Record<string,string> = {
        common:'#9ca3af', uncommon:'#4ade80', rare:'#60a5fa', epic:'#a855f7', legendary:'#f59e0b'
      };
      const labelMap: Record<string,string> = {
        common:'Com√∫n', uncommon:'Poco com√∫n', rare:'Raro', epic:'√âpico', legendary:'Legendario'
      };
      queueAchievementToast({
        name: a.name,
        desc: a.description,
        icon: a.icon,
        rarity: labelMap[a.rarity] ?? a.rarity,
        color: colorMap[a.rarity] ?? '#a855f7',
      });
      // React if AchievementsPanel is present
      if ((window as any).loadAchievements) (window as any).loadAchievements();
    }
  } catch {}
};

async function checkNewAchievements() {
  // Don't auto-check on /logros because AchievementsPanel already does it
  if (window.location.pathname === '/logros') return;

  try {
    const res = await fetch('/api/achievements', { credentials: 'include' });
    if (!res.ok) return;
    const data = await res.json();

    if (data.newlyUnlocked?.length > 0) {
      await new Promise<void>(r => setTimeout(r, 1000));
      for (const id of data.newlyUnlocked) {
        const b = (data.achievements || []).find((ach: any) => ach.id === id);
        if (b) {
          queueAchievementToast({ 
            name: b.name, 
            desc: b.description, 
            icon: b.icon, 
            rarity: b.rarityLabel, 
            color: b.rarityColor 
          });
        }
      }
    }
  } catch (err) {}
}

// Boot check
if (document.readyState === 'complete') {
  checkNewAchievements();
} else {
  window.addEventListener('load', checkNewAchievements);
}
</script>
