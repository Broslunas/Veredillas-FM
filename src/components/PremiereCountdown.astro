---
interface Props {
  targetDate: Date;
  title: string;
}

const { targetDate, title } = Astro.props;
const isoDate = targetDate.toISOString();
---

<div class="premiere-countdown" data-target={isoDate}>
    <div class="countdown-content">
        <div class="badge">Estreno Oficial</div>
        <h2>{title}</h2>
        
        <div class="timer">
            <div class="time-unit">
                <span class="value days">00</span>
                <span class="label">Días</span>
            </div>
            <span class="separator">:</span>
            <div class="time-unit">
                <span class="value hours">00</span>
                <span class="label">Hrs</span>
            </div>
            <span class="separator">:</span>
            <div class="time-unit">
                <span class="value minutes">00</span>
                <span class="label">Min</span>
            </div>
            <span class="separator">:</span>
            <div class="time-unit">
                <span class="value seconds">00</span>
                <span class="label">Seg</span>
            </div>
        </div>
        
        <div class="music-player-container">
        <div class="music-player-container">
            <div class="custom-select-wrapper">
                <div class="custom-select-trigger" tabindex="0">
                    <span class="selection">Lofi Chill</span>
                    <div class="arrow"></div>
                </div>
                <div class="custom-options">
                    <div class="custom-option selected" data-value="https://stream.zeno.fm/0r0xa792kwzuv">Lofi Chill</div>
                    <div class="custom-option" data-value="https://s1.we4stream.com:2020/stream/locaurban">Reggaeton</div>
                    <div class="custom-option" data-value="https://live.powerhitz.com/1power?aw_0_req.gdpr=true">Trap</div>
                    <div class="custom-option" data-value="https://listen.technobase.fm/tunein-mp3">Techno</div>
                    <div class="custom-option" data-value="https://streams.ilovemusic.de/iloveradio10.mp3">Hip Hop</div>
                </div>
            </div>

            <button class="music-btn music-toggle-btn" aria-label="Activar música de fondo">
                <div class="equalizer">
                    <span class="bar bar-1"></span>
                    <span class="bar bar-2"></span>
                    <span class="bar bar-3"></span>
                    <span class="bar bar-4"></span>
                </div>
                <span class="music-label">Activar Música</span>
            </button>
            <audio class="waiting-music" preload="none" loop>
                <source src="https://stream.zeno.fm/0r0xa792kwzuv" type="audio/mpeg">
            </audio>
        </div>

        <div class="status-message">Esperando que llegue la hora...</div>
    </div>
</div>

<style>
    .premiere-countdown {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--color-surface) 0%, #000 100%);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-2xl);
        text-align: center;
        min-height: 400px;
        position: relative;
        overflow: hidden;
    }

    .premiere-countdown::before {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at center, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
        pointer-events: none;
    }

    .badge {
        background: var(--color-primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: bold;
        margin-bottom: var(--spacing-md);
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
    }

    h2 {
        font-size: clamp(1.5rem, 5vw, 2.5rem);
        margin-bottom: var(--spacing-sm);
        background: linear-gradient(white, #aaa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .subtitle {
        color: var(--color-text-muted);
        font-size: 1.1rem;
        margin-bottom: var(--spacing-xl);
    }

    .timer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        font-variant-numeric: tabular-nums;
        margin-bottom: var(--spacing-xl);
    }

    .time-unit {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .value {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
        color: var(--color-text-main);
    }

    .label {
        font-size: 0.7rem;
        text-transform: uppercase;
        color: var(--color-text-muted);
        margin-top: 5px;
        letter-spacing: 0.05em;
    }

    .separator {
        font-size: 2rem;
        color: var(--color-text-muted);
        margin-bottom: 20px; /* Align with numbers */
    }

    .status-message {
        font-size: 0.9rem;
        color: var(--color-primary);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Music Player Styles */
    .music-player-container {
        margin-bottom: var(--spacing-lg);
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
    }

    /* Custom Dropdown Styles */
    .custom-select-wrapper {
        position: relative;
        user-select: none;
        width: 100%;
        max-width: 300px;
    }

    .custom-select-trigger {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 12px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .custom-select-trigger:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .selection {
        font-size: 0.95rem;
        color: var(--color-text-main);
        font-weight: 500;
    }

    .arrow {
        width: 10px;
        height: 10px;
        border-bottom: 2px solid rgba(255,255,255,0.7);
        border-right: 2px solid rgba(255,255,255,0.7);
        transform: rotate(45deg);
        transition: transform 0.3s ease;
        margin-top: -4px;
    }

    .custom-select-wrapper.open .arrow {
        transform: rotate(-135deg);
        margin-top: 4px;
    }

    .custom-select-wrapper.open .custom-select-trigger {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb, 139, 92, 246), 0.2);
    }

    .custom-options {
        position: absolute;
        display: block;
        top: 100%;
        left: 0;
        right: 0;
        background: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-top: 8px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        z-index: 100;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    .custom-select-wrapper.open .custom-options {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        transform: translateY(0);
    }

    .custom-option {
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        color: rgba(255,255,255,0.8);
    }

    .custom-option:last-child {
        border-bottom: none;
    }

    .custom-option:hover {
        background: rgba(var(--color-primary-rgb, 139, 92, 246), 0.2);
        color: white;
        padding-left: 25px;
    }

    .custom-option.selected {
        background: var(--color-primary);
        color: white;
    }

    .music-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--color-text-muted);
        transition: all 0.3s ease;
    }

    .music-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateY(-2px);
    }

    .music-btn.playing {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
        color: #a78bfa;
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);
    }

    .music-btn.playing .music-label {
        color: white;
    }

    .equalizer {
        display: flex;
        align-items: flex-end;
        height: 12px;
        gap: 2px;
    }

    .bar {
        width: 3px;
        background: currentColor;
        border-radius: 1px;
        animation: eq 1s infinite ease-in-out;
        animation-play-state: paused;
    }

    .music-btn.playing .bar {
        animation-play-state: running;
    }

    .bar-1 { height: 6px; }
    .bar-2 { height: 12px; }
    .bar-3 { height: 8px; }
    .bar-4 { height: 5px; }

    @keyframes eq {
        0% { height: 4px; }
        50% { height: 12px; }
        100% { height: 4px; }
    }

    @media (max-width: 600px) {
        .premiere-countdown {
            padding: var(--spacing-md);
            min-height: 300px;
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
        }

        .timer {
            gap: var(--spacing-xs, 0.5rem);
            width: 100%;
            justify-content: space-between; /* Distribute space evenly if needed or keep center */
        }

        .time-unit {
            min-width: unset;
        }

        .value { 
            font-size: clamp(1.5rem, 8vw, 2rem); 
        }

        .label {
            font-size: 0.6rem;
        }

        .separator { 
            font-size: 1.2rem;
            margin-bottom: 12px;
        }
    }

    @media (max-width: 380px) {
        .value { font-size: 1.2rem; }
        .separator { font-size: 1rem; }
        .badge { font-size: 0.7rem; padding: 2px 8px; }
    }
</style>

<script>
    class PremiereCountdown {
        el: HTMLElement;
        targetDate: Date;
        daysEl: HTMLElement | null;
        hoursEl: HTMLElement | null;
        minutesEl: HTMLElement | null;
        secondsEl: HTMLElement | null;
        wrapper: HTMLElement | null;
        interval: number | undefined;
        audio: HTMLAudioElement | null;
        musicBtn: HTMLElement | null;
        musicLabel: HTMLElement | null;
        vibeSelectWrapper: HTMLElement | null;
        vibeSelectTrigger: HTMLElement | null;
        vibeOptions: NodeListOf<HTMLElement>;
        selectionText: HTMLElement | null;
        isPlaying: boolean = false;
        currentUrl: string;

        constructor(el: HTMLElement) {
            this.el = el;
            this.targetDate = new Date(el.dataset.target || '');
            this.daysEl = el.querySelector('.days');
            this.hoursEl = el.querySelector('.hours');
            this.minutesEl = el.querySelector('.minutes');
            this.secondsEl = el.querySelector('.seconds');
            this.wrapper = el.querySelector('.premiere-countdown');
            this.audio = el.querySelector('.waiting-music');
            this.musicBtn = el.querySelector('.music-toggle-btn');
            this.musicLabel = el.querySelector('.music-label');
            
            // Custom Select Elements
            this.vibeSelectWrapper = el.querySelector('.custom-select-wrapper');
            this.vibeSelectTrigger = el.querySelector('.custom-select-trigger');
            this.vibeOptions = el.querySelectorAll('.custom-option');
            this.selectionText = el.querySelector('.selection');

            this.currentUrl = "https://stream.zeno.fm/0r0xa792kwzuv"; // Default
            
            this.setupAudio();
            this.start();
        }

        update() {
            const now = new Date();
            const diff = this.targetDate.getTime() - now.getTime();

            if (diff <= 0) {
                this.finish();
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if(this.daysEl) this.daysEl.textContent = String(days).padStart(2, '0');
            if(this.hoursEl) this.hoursEl.textContent = String(hours).padStart(2, '0');
            if(this.minutesEl) this.minutesEl.textContent = String(minutes).padStart(2, '0');
            if(this.secondsEl) this.secondsEl.textContent = String(seconds).padStart(2, '0');
        }

        start() {
            this.update();
            this.interval = window.setInterval(() => this.update(), 1000);
        }

        setupAudio() {
            if (!this.musicBtn || !this.audio) {
                console.warn('Music elements not found', { btn: this.musicBtn, audio: this.audio });
                return;
            }

            this.musicBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.toggleMusic();
            });

            // Custom Select Logic
            if(this.vibeSelectTrigger && this.vibeSelectWrapper) {
                this.vibeSelectTrigger.addEventListener('click', () => {
                    this.vibeSelectWrapper?.classList.toggle('open');
                });
                
                // Close on click outside
                document.addEventListener('click', (e) => {
                    if(this.vibeSelectWrapper && !this.vibeSelectWrapper.contains(e.target as Node)) {
                        this.vibeSelectWrapper.classList.remove('open');
                    }
                });
            }

            this.vibeOptions.forEach(option => {
                option.addEventListener('click', () => {
                   this.switchGenre(option);
                   this.vibeSelectWrapper?.classList.remove('open');
                });
            });
            
            this.audio.volume = 0.5;
            
            // Handle audio errors
            this.audio.addEventListener('error', (e) => {
                console.error('Audio stream error:', this.audio?.error);
                if(this.musicLabel) this.musicLabel.textContent = "Error de conexión";
                this.isPlaying = false;
                this.musicBtn?.classList.remove('playing');
            });
        }

        switchGenre(option: HTMLElement) {
            // Update selected visual state
            this.vibeOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');

            const newUrl = option.dataset.value;
            const genreName = option.textContent || "Música";
            
            // Update trigger text
            if(this.selectionText) this.selectionText.textContent = genreName;
            
            if (newUrl && this.audio) {
                this.currentUrl = newUrl;
                this.audio.src = newUrl; // Direct source change
                
                // If it was playing, play the new one immediately
                if (this.isPlaying) {
                     if(this.musicLabel) this.musicLabel.textContent = `Conectando con ${genreName}...`;
                     this.audio.play().then(() => {
                         if(this.musicLabel) this.musicLabel.textContent = `Escuchando ${genreName}`;
                     }).catch(e => {
                         console.error("Switch play failed:", e);
                         this.isPlaying = false;
                         this.musicBtn?.classList.remove('playing');
                     });
                } else {
                    // Update label but don't play yet
                    if(this.musicLabel) this.musicLabel.textContent = `Activar ${genreName}`;
                }
            }
        }

        toggleMusic() {
            if (!this.audio || !this.musicBtn) return;

            if (this.isPlaying) {
                this.audio.pause();
                this.isPlaying = false;
                this.musicBtn.classList.remove('playing');
                // Reset label to current selection
                const genreName = this.selectionText ? this.selectionText.textContent : "Música";
                if(this.musicLabel) this.musicLabel.textContent = `Activar ${genreName}`;
            } else {
                if(this.musicLabel) this.musicLabel.textContent = "Conectando...";
                
                // Update source if needed (ensure cache busting isn't blocking us, but usually streams handle it)
                // For switching genres we already updated .src so we just play()
                
                this.audio.play().then(() => {
                    this.isPlaying = true;
                    this.musicBtn!.classList.add('playing');
                    const genreName = this.selectionText ? this.selectionText.textContent : "Música";
                    if(this.musicLabel) this.musicLabel!.textContent = `Escuchando ${genreName}`;
                }).catch(e => {
                    console.error("Audio play failed:", e);
                    this.isPlaying = false;
                    this.musicBtn!.classList.remove('playing');
                    if(this.musicLabel) this.musicLabel!.textContent = "No disponible";
                });
            }
        }

        async finish() {
            if(this.interval) clearInterval(this.interval);
            
            // Fade out music if playing
            if (this.audio && this.isPlaying) {
                const fadeAudio = setInterval(() => {
                    if (this.audio && this.audio.volume > 0.05) {
                        this.audio.volume -= 0.05;
                    } else {
                        clearInterval(fadeAudio);
                        this.audio?.pause();
                    }
                }, 100);
            }
            
            // 1. CONFETTI ALERT!
            // @ts-ignore
            import('canvas-confetti').then(({ default: confetti }) => {
                 this.fireConfetti(confetti);
            });
            
            // 2. UI Transition
            const countdownWrapper = document.getElementById('premiere-countdown-wrapper');
            const playerWrapper = document.getElementById('premiere-player-wrapper');

            if(countdownWrapper && playerWrapper) {
                // Fade out countdown
                countdownWrapper.style.transition = 'opacity 1s ease-out, transform 1s ease-out';
                countdownWrapper.style.opacity = '0';
                countdownWrapper.style.transform = 'scale(0.95)';
                
                // Show player container
                playerWrapper.classList.remove('hidden');
                playerWrapper.style.display = 'block';
                
                // Wait small tick then fade in
                setTimeout(() => {
                    playerWrapper.style.opacity = '1';
                    
                    // Remove countdown from DOM after fade
                    setTimeout(() => {
                         countdownWrapper.style.display = 'none';
                         // Dispatch event to notify others (like MiniPlayer to auto-start)
                         document.dispatchEvent(new CustomEvent('premiere-started'));
                    }, 1000);
                }, 100);
            } else {
                 // Fallback if structure missing
                 window.location.reload();
            }
        }

        fireConfetti(confetti: any) {
            const count = 200;
            const defaults = {
                origin: { y: 0.7 }
            };

            function fire(particleRatio: number, opts: any) {
                confetti({
                    ...defaults,
                    ...opts,
                    particleCount: Math.floor(count * particleRatio)
                });
            }

            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        }
    }

    document.addEventListener('astro:page-load', () => {
        const els = document.querySelectorAll('.premiere-countdown');
        els.forEach(el => new PremiereCountdown(el as HTMLElement));
    });

    // Fallback for non-view-transitions
    document.addEventListener('DOMContentLoaded', () => {
        const els = document.querySelectorAll('.premiere-countdown');
        els.forEach(el => new PremiereCountdown(el as HTMLElement));
    });
</script>
