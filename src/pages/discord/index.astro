---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Fetch latest episodes to display in the Discord Activity
const allEpisodes = await getCollection('episodios');
const latestEpisodes = allEpisodes
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
  .slice(0, 5);
---

<Layout title="Veredillas FM - Discord Activity">
  <main class="discord-activity-wrapper">
    <div id="app-container" class="discord-app-container">
      <!-- Header -->
      <header class="discord-header">
        <div class="discord-header-left">
          <div class="discord-logo-box">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
              <path d="M9 18V5l12-2v13"></path>
              <circle cx="6" cy="18" r="3"></circle>
              <circle cx="18" cy="16" r="3"></circle>
            </svg>
          </div>
          <div class="discord-header-titles">
            <h1>Veredillas FM</h1>
            <p id="status-text">Cargando SDK...</p>
          </div>
        </div>
        
        <div id="user-profile" class="discord-user-profile">
          <img id="user-avatar" src="" alt="Avatar" />
          <span id="user-name"></span>
        </div>
      </header>

      <!-- Content -->
      <div id="main-content" class="discord-main-grid">
        
        <!-- Left Column: Episodes List -->
        <div class="discord-episodes-list">
          <h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
            Últimos Episodios
          </h2>
          
          <div class="discord-episodes-container">
            {latestEpisodes.map((ep) => (
              <div class="discord-episode-card" data-audio={ep.data.audioUrl} data-title={ep.data.title}>
                <img src={ep.data.image || '/images/default-cover.jpg'} alt={ep.data.title} class="discord-cover-img" />
                <div class="discord-episode-info">
                  <h3 class="discord-episode-title">{ep.data.title}</h3>
                  <p class="discord-episode-desc">{ep.data.description}</p>
                </div>
                <button class="discord-play-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                </button>
              </div>
            ))}
          </div>
        </div>

        <!-- Right Column: Player -->
        <div class="discord-player-section">
          <div class="discord-player-card">
             <h3 class="discord-player-heading">Reproductor</h3>
             
             <div id="now-playing" class="discord-now-playing">
                <div class="discord-big-cover">
                  <svg id="default-cover" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                  <img id="np-cover" src="" class="discord-hidden" />
                </div>
                <h4 id="np-title">Ningún episodio seleccionado</h4>
                <p class="discord-player-hint">Selecciona un episodio para escuchar con tus amigos</p>
                
                <audio id="audio-player" class="discord-audio-ctrl discord-hidden" controls></audio>
             </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <style>
    /* Scoped CSS for Discord Page */
    .discord-activity-wrapper {
      min-height: 100vh;
      background-color: #313338;
      color: #ffffff;
      padding: 1rem;
    }

    .discord-app-container {
      max-width: 56rem;
      margin: 0 auto;
    }

    /* Header */
    .discord-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      background-color: #2b2d31;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid #1e1f22;
    }

    .discord-header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .discord-logo-box {
      width: 3rem;
      height: 3rem;
      background-color: #5865F2; /* Discord brand primary */
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .discord-logo-box svg {
      color: #ffffff;
    }

    .discord-header-titles h1 {
      font-size: 1.25rem;
      font-weight: 700;
      margin: 0;
    }

    .discord-header-titles p {
      font-size: 0.875rem;
      color: #9ca3af;
      margin: 0;
    }

    .discord-user-profile {
      display: none; /* hidden by default */
      align-items: center;
      gap: 0.75rem;
      background-color: #1e1f22;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
    }

    .discord-user-profile.active {
      display: flex;
    }

    .discord-user-profile img {
      width: 2rem;
      height: 2rem;
      border-radius: 9999px;
    }

    .discord-user-profile span {
      font-weight: 500;
      font-size: 0.875rem;
    }

    /* Main Grid */
    .discord-main-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      opacity: 0.5;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .discord-main-grid.ready {
      opacity: 1;
      pointer-events: auto;
    }

    @media (min-width: 768px) {
      .discord-main-grid {
        grid-template-columns: 2fr 1fr; /* 2 cols left, 1 col right */
      }
    }

    /* Left Column */
    .discord-episodes-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .discord-episodes-list h2 {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0;
    }

    .discord-episodes-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .discord-episode-card {
      background-color: #2b2d31;
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid #1e1f22;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }

    .discord-episode-card:hover {
      background-color: #313338;
    }

    .discord-cover-img {
      width: 4rem;
      height: 4rem;
      border-radius: 0.5rem;
      object-fit: cover;
    }

    .discord-episode-info {
      flex: 1;
      min-width: 0;
    }

    .discord-episode-title {
      font-weight: 700;
      font-size: 0.875rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
      transition: color 0.2s ease;
    }

    .discord-episode-card:hover .discord-episode-title {
      color: #5865F2;
    }

    .discord-episode-desc {
      font-size: 0.75rem;
      color: #9ca3af;
      margin: 0.25rem 0 0 0;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .discord-play-btn {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 9999px;
      background-color: #1e1f22;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .discord-episode-card:hover .discord-play-btn {
      background-color: #5865F2;
    }

    /* Right Column (Player) */
    .discord-player-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .discord-player-card {
      background-color: #2b2d31;
      padding: 1.25rem;
      border-radius: 0.75rem;
      border: 1px solid #1e1f22;
      position: sticky;
      top: 1rem;
    }

    .discord-player-heading {
      font-weight: 700;
      font-size: 0.875rem;
      margin: 0 0 1rem 0;
      text-transform: uppercase;
      color: #9ca3af;
      letter-spacing: 0.05em;
    }

    .discord-now-playing {
      text-align: center;
    }

    .discord-big-cover {
      width: 100%;
      aspect-ratio: 1 / 1;
      background-color: #1e1f22;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .discord-big-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .discord-big-cover svg {
      color: #4b5563;
    }

    .discord-now-playing h4 {
      font-weight: 700;
      font-size: 0.875rem;
      margin: 0 0 0.25rem 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .discord-player-hint {
      font-size: 0.75rem;
      color: #9ca3af;
      margin: 0 0 1.5rem 0;
    }

    .discord-audio-ctrl {
      width: 100%;
      height: 2.5rem;
    }

    .discord-hidden {
      display: none !important;
    }
  </style>

  <script>
    import { setupDiscordSdk, discordSdk, isDiscord } from '../../lib/discord';

    async function init() {
      const statusText = document.getElementById('status-text');
      const mainContent = document.getElementById('main-content');
      const userProfile = document.getElementById('user-profile');
      
      try {
        if (statusText) statusText.textContent = "Conectando al SDK...";
        
        await setupDiscordSdk();
        
        if (statusText) statusText.textContent = "Autenticando...";
        
        // Authorize with Discord Client
        const { code } = await discordSdk.commands.authorize({
          client_id: import.meta.env.PUBLIC_DISCORD_CLIENT_ID,
          response_type: "code",
          state: "",
          prompt: "none",
          scope: [
            "identify",
            "guilds",
          ],
        });

        if (statusText) statusText.textContent = "Obteniendo datos...";

        let access_token = "mock_token";

        if (isDiscord) {
            // Obtain token from our own server
            const response = await fetch('/api/discord/token', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ code }),
            });

            if (!response.ok) {
              throw new Error('No se pudo obtener el token de acceso');
            }

            const data = await response.json();
            access_token = data.access_token;
        }
        
        try {
            const result = await discordSdk.commands.authenticate({
                access_token,
            });
            
            const user = result.user;
            
            // UI Updates
            if (statusText) statusText.textContent = "Conectado";
            if (mainContent) {
                mainContent.classList.add('ready');
            }
            if (userProfile) {
                userProfile.classList.add('active');
                
                const avatar = document.getElementById('user-avatar') as HTMLImageElement;
                const name = document.getElementById('user-name');
                
                if (user.avatar) {
                    avatar.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                } else {
                    const defaultAvatarIndex = Math.abs(Number(user.id) >> 22) % 6;
                    avatar.src = `https://cdn.discordapp.com/embed/avatars/${defaultAvatarIndex}.png`;
                }
                
                if (name) name.textContent = user.username;
            }

            // Set up player logic
            setupPlayer();
            
        } catch (authErr) {
            console.error(authErr);
            if (statusText) statusText.textContent = "Error de autenticación.";
        }

      } catch (e: any) {
        console.error("Error inicializando SDK de Discord:", e);
        if (statusText) statusText.textContent = `Error: ${e?.message || String(e)}`;
        
        // Enable UI anyway for fallback/testing if not in Discord
        if (!isDiscord && mainContent) {
             mainContent.classList.add('ready');
             const errMsg = document.createElement('p');
             errMsg.style.color = 'salmon';
             errMsg.style.fontSize = '12px';
             errMsg.textContent = `Modo Prueba. Motivo del fallo local: ${e?.message || String(e)}`;
             statusText.appendChild(errMsg);
             setupPlayer();
        }
      }
    }

    function setupPlayer() {
        const cards = document.querySelectorAll('.discord-episode-card');
        const audioPlayer = document.getElementById('audio-player') as HTMLAudioElement;
        const npTitle = document.getElementById('np-title');
        const npCover = document.getElementById('np-cover') as HTMLImageElement;
        const defaultCover = document.getElementById('default-cover');

        cards.forEach(card => {
            card.addEventListener('click', () => {
                const audioUrl = card.getAttribute('data-audio');
                const title = card.getAttribute('data-title');
                const img = card.querySelector('img')?.src;

                if (audioUrl && audioPlayer) {
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('discord-hidden');
                    audioPlayer.play();
                    
                    if (npTitle) npTitle.textContent = title || 'Reproduciendo...';
                    
                    if (npCover && img && defaultCover) {
                        npCover.src = img;
                        npCover.classList.remove('discord-hidden');
                        defaultCover.classList.add('discord-hidden');
                    }
                }
            });
        });
    }

    // Initialize only in client
    if (typeof window !== 'undefined') {
      init();
    }
  </script>
</Layout>
