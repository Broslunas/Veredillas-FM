---
import Layout from '../../../layouts/Layout.astro';
import AdminNav from '../../../components/admin/AdminNav.astro';
import { getUserFromCookie } from '../../../lib/auth';
import User from '../../../models/User';
import dbConnect from '../../../lib/mongodb';
import { getCollection } from 'astro:content';

export const prerender = false;

const cookieHeader = Astro.request.headers.get('cookie');
const userPayload = getUserFromCookie(cookieHeader);

if (!userPayload) {
  return Astro.redirect('/404');
}

await dbConnect();

const currentUser = await User.findById(userPayload.userId);
if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'owner')) {
  return Astro.redirect('/404'); 
}

const users = await User.find({}).sort({ createdAt: -1 });

// Fetch Episodes & Clips for Client-side enrichment
const allEpisodes = await getCollection('episodios');
const episodesData: Record<string, { title: string, image: string }> = {};
const clipsData: Record<string, { title: string, episodeSlug: string, image: string }> = {};

allEpisodes.forEach(e => {
    const epImage = typeof e.data.image === 'string' ? e.data.image : (e.data.image as any)?.src || '';
    episodesData[e.slug] = {
        title: e.data.title,
        image: epImage
    };
    if (e.data.clips) {
        e.data.clips.forEach((clip: any) => {
             const match = clip.url.match(/(?:youtube\.com\/shorts\/|youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^?&]+)/);
             const videoId = match ? match[1] : null;
             if (videoId) {
                 clipsData[videoId] = {
                     title: clip.title,
                     episodeSlug: e.slug,
                     image: epImage
                 };
             }
        });
    }
});

function formatTime(seconds: number) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return `${h}h ${m}m`;
}
---

<Layout title="Gestión de Usuarios - Admin" robots="noindex, nofollow">
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="grid-overlay"></div>
    </div>

    <div class="admin-container fade-in-up" id="adminContainer" data-episodes={JSON.stringify(episodesData)} data-clips={JSON.stringify(clipsData)}>
        <div class="admin-header">
            <div class="header-content">
                <h1>Usuarios</h1>
                <p>Gestión de la base de usuarios ({users.length} total)</p>
            </div>
            <div class="header-actions">
                <button id="sendBulkNewsletterBtn" class="btn-bulk-newsletter" title="Enviar newsletter personalizada a todos los suscritos">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                    <span>Enviar a Todos</span>
                </button>
            </div>
        </div>

        <AdminNav />

        <div class="section-container glass-panel">
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Registro</th>
                            <th>Último Acceso</th>
                            <th>Tiempo</th>
                            <th>Estado</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {users.map((user) => (
                            <tr>
                                <td>
                                    <div class="user-cell">
                                        <img src={user.picture || `https://ui-avatars.com/api/?name=${user.name}`} alt={user.name} class="user-avatar" />
                                        <span class="user-name">{user.name}</span>
                                    </div>
                                </td>
                                <td class="text-muted">{user.email}</td>
                                <td>
                                    <span class={`role-badge ${user.role}`}>
                                        {user.role}
                                    </span>
                                </td>
                                <td title={new Date(user.createdAt).toLocaleString()} class="text-sm">
                                    {new Date(user.createdAt).toLocaleDateString()}
                                </td>
                                <td title={user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A'} class="text-sm">
                                    {user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : '-'}
                                </td>
                                <td class="font-mono text-sm">{formatTime(user.listeningTime || 0)}</td>
                                <td>
                                    <span class={`status-badge ${user.newsletter ? 'active' : 'inactive'}`}>
                                        {user.newsletter ? 'Suscrito' : 'Inactivo'}
                                    </span>
                                </td>
                                <td class="text-right">
                                    <div class="actions-cell">
                                        <button class="icon-btn view-btn" data-user={JSON.stringify(user)} aria-label="Ver detalles" title="Ver Detalles">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                        <button class="icon-btn edit-btn" data-user={JSON.stringify(user)} aria-label="Editar usuario" title="Editar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        <button class="icon-btn test-to-me-btn" data-id={user._id} data-name={user.name} aria-label="Enviarme prueba a mí" title="Enviarme prueba a mí con sus datos">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                                        </button>
                                        {user._id.toString() !== currentUser._id.toString() && (
                                            <button class="icon-btn delete-btn" data-id={user._id} aria-label="Eliminar usuario" title="Eliminar">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal-backdrop hidden">
        <div class="modal-content glass-panel" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Editar Usuario Superior</h3>
                <button id="closeModal" class="close-btn">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="userId" />
                
                <div class="dashboard-columns mt-0" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editName">Nombre</label>
                        <input type="text" id="editName" name="name" class="modern-input" required />
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" name="email" class="modern-input" required />
                    </div>
                </div>

                <div class="form-group">
                    <label for="editBio">Bio</label>
                    <textarea id="editBio" name="bio" class="modern-input" rows="2"></textarea>
                </div>

                <div class="dashboard-columns mt-0" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editRole">Rol</label>
                        <select id="editRole" name="role" class="modern-input">
                            <option value="user">Usuario</option>
                            <option value="admin">Administrador</option>
                            <option value="owner">Dueño</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Tiempo Escuchado</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="editListeningHours" class="modern-input" placeholder="Horas" min="0" style="width: 33%;" />
                            <input type="number" id="editListeningMinutes" class="modern-input" placeholder="Minutos" min="0" max="59" style="width: 33%;" />
                            <input type="number" id="editListeningSeconds" class="modern-input" placeholder="Segundos" min="0" max="59" style="width: 33%;" />
                        </div>
                    </div>
                </div>

                <div class="dashboard-columns mt-0" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="editCurrentStreak">Racha Actual</label>
                        <input type="number" id="editCurrentStreak" name="currentStreak" class="modern-input" min="0" />
                    </div>
                    <div class="form-group">
                        <label for="editMaxStreak">Racha Máxima</label>
                        <input type="number" id="editMaxStreak" name="maxStreak" class="modern-input" min="0" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="editFavorites">Episodios Favoritos (Slugs separados por coma)</label>
                    <input type="text" id="editFavorites" name="favorites" class="modern-input" placeholder="ej: ep-1, ep-2" />
                </div>

                <div class="form-group checkbox-group" style="margin-top: 0.5rem;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editNewsletter" name="newsletter" />
                        <span class="checkbox-custom"></span>
                        <span class="label-text">Suscrito a la Newsletter</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancelEdit">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View User Details Dashboard Modal -->
    <div id="viewUserModal" class="modal-backdrop hidden">
        <div class="modal-content glass-panel super-wide-modal">
            <div class="modal-header">
                <h3>Dashboard del Usuario</h3>
                <button id="closeViewModal" class="close-btn">&times;</button>
            </div>
            
            <div id="viewUserDetails" class="user-dashboard-scrollable">
                <div class="dashboard-hero">
                    <img id="viewAvatar" src="" alt="" class="dashboard-avatar" />
                    <div class="hero-info">
                        <div class="hero-title-row">
                            <h2 id="viewName"></h2>
                            <span id="viewRoleBadge" class="role-badge"></span>
                            <span id="viewNewsletterBadge" class="status-badge"></span>
                        </div>
                        <p id="viewEmail" class="hero-email"></p>
                        <p class="hero-meta">Miembro desde: <span id="viewJoined"></span> <span class="dot-sep">&bull;</span> Último activo: <span id="viewLastActive"></span></p>
                    </div>
                </div>

                <div class="stats-cards-grid">
                    <div class="stat-card">
                        <div class="stat-icon time-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
                        <div class="stat-data">
                            <h4>Tiempo Escuchado</h4>
                            <span id="viewListeningTime" class="stat-value font-mono"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon ep-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></div>
                        <div class="stat-data">
                            <h4>Episodios Completados</h4>
                            <span id="viewCompletedCount" class="stat-value"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon streak-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg></div>
                        <div class="stat-data">
                            <h4>Racha (Actual/Max)</h4>
                            <span id="viewStreak" class="stat-value"></span>
                        </div>
                    </div>
                </div>

                <div class="dashboard-columns">
                    <div class="dash-col dash-main">
                        <div class="dash-section">
                            <div class="section-header-row">
                                <h4 class="section-title">Historial de Reproducción</h4>
                            </div>
                            <div class="history-list-wrapper">
                                <ul id="viewHistoryList" class="rich-list history-list"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dash-col dash-side">
                        <div class="dash-section">
                            <div class="section-header-row">
                                <h4 class="section-title">Episodios Favoritos (<span id="viewFavCount">0</span>)</h4>
                            </div>
                            <ul id="viewFavoritesList" class="rich-list mini-list"></ul>
                        </div>
                        <div class="dash-section mt-4">
                             <div class="section-header-row">
                                <h4 class="section-title">Clips Guardados (<span id="viewClipsCount">0</span>)</h4>
                            </div>
                            <ul id="viewClipsList" class="rich-list mini-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-backdrop hidden">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar Acción</h3>
                <button id="closeConfirmModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="color: var(--color-text-muted); line-height: 1.6; margin-bottom: 2rem;"></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="cancelConfirm">Cancelar</button>
                <button type="button" class="btn-save" id="executeConfirm" style="background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        declare global {
            interface Window {
                showToast: (message: string, type?: 'info' | 'success' | 'error') => void;
                customConfirm: (title: string, message: string, callback: () => void) => void;
            }
        }

        function attachEventListeners() {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm') as HTMLFormElement;
            const closeBtn = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelEdit'); // Matched with HTML ID
            
            // View Modal Elements
            const viewModal = document.getElementById('viewUserModal');
            const closeViewBtn = document.getElementById('closeViewModal');

            // Confirm Modal Elements
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirm');
            const executeConfirmBtn = document.getElementById('executeConfirm');
            const closeConfirmBtn = document.getElementById('closeConfirmModal');

            let confirmCallback: (() => void) | null = null;

            function openModal(modalEl: HTMLElement | null) {
                if(modalEl) modalEl.classList.remove('hidden');
            }

            function closeModal(modalEl: HTMLElement | null) {
                if(modalEl) modalEl.classList.add('hidden');
            }

            window.customConfirm = (title: string, message: string, callback: () => void) => {
                if (confirmTitle) confirmTitle.innerText = title;
                if (confirmMessage) confirmMessage.innerText = message;
                confirmCallback = callback;
                openModal(confirmModal);
            };

            if (executeConfirmBtn) {
                executeConfirmBtn.onclick = () => {
                    if (confirmCallback) confirmCallback();
                    closeModal(confirmModal);
                };
            }

            // Edit Modal Closers
            if (closeBtn) closeBtn.onclick = () => closeModal(modal);
            if (cancelBtn) cancelBtn.onclick = () => closeModal(modal);
            
             // View Modal Closers
            if (closeViewBtn) closeViewBtn.onclick = () => closeModal(viewModal);

            // Confirm Modal Closers
            if (closeConfirmBtn) closeConfirmBtn.onclick = () => closeModal(confirmModal);
            if (cancelConfirmBtn) cancelConfirmBtn.onclick = () => closeModal(confirmModal);
            
            // Click outside
            if (modal) {
                 modal.onclick = (e) => {
                    if (e.target === modal) closeModal(modal);
                };
            }
            if (viewModal) {
                 viewModal.onclick = (e) => {
                    if (e.target === viewModal) closeModal(viewModal);
                };
            }

            // Edit Buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', (e) => {
                     const target = e.currentTarget as HTMLElement;
                     const userData = JSON.parse(target.dataset.user || '{}');
                     
                     const idInput = document.getElementById('editUserId') as HTMLInputElement;
                     const nameInput = document.getElementById('editName') as HTMLInputElement;
                     const emailInput = document.getElementById('editEmail') as HTMLInputElement;
                     const bioInput = document.getElementById('editBio') as HTMLTextAreaElement;
                     const roleInput = document.getElementById('editRole') as HTMLSelectElement;
                     const listeningHoursInput = document.getElementById('editListeningHours') as HTMLInputElement;
                     const listeningMinutesInput = document.getElementById('editListeningMinutes') as HTMLInputElement;
                     const listeningSecondsInput = document.getElementById('editListeningSeconds') as HTMLInputElement;
                     const currentStreakInput = document.getElementById('editCurrentStreak') as HTMLInputElement;
                     const maxStreakInput = document.getElementById('editMaxStreak') as HTMLInputElement;
                     const favoritesInput = document.getElementById('editFavorites') as HTMLInputElement;
                     const newsletterInput = document.getElementById('editNewsletter') as HTMLInputElement;

                     if(idInput) idInput.value = userData._id;
                     if(nameInput) nameInput.value = userData.name;
                     if(emailInput) emailInput.value = userData.email;
                     if(bioInput) bioInput.value = userData.bio || '';
                     if(roleInput) roleInput.value = userData.role;
                     
                     const totalSeconds = userData.listeningTime || 0;
                     if(listeningHoursInput) listeningHoursInput.value = Math.floor(totalSeconds / 3600).toString();
                     if(listeningMinutesInput) listeningMinutesInput.value = Math.floor((totalSeconds % 3600) / 60).toString();
                     if(listeningSecondsInput) listeningSecondsInput.value = (totalSeconds % 60).toString();
                     
                     if(currentStreakInput) currentStreakInput.value = userData.currentStreak || 0;
                     if(maxStreakInput) maxStreakInput.value = userData.maxStreak || 0;
                     if(favoritesInput) favoritesInput.value = (userData.favorites || []).join(', ');
                     if(newsletterInput) newsletterInput.checked = !!userData.newsletter;
                     
                     openModal(modal);
                });
            });

            // View Buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget as HTMLElement;
                    const userData = JSON.parse(target.dataset.user || '{}');

                    // Populate View Modal
                    const avatar = document.getElementById('viewAvatar') as HTMLImageElement;
                    const name = document.getElementById('viewName');
                    const email = document.getElementById('viewEmail');
                    const roleBadge = document.getElementById('viewRoleBadge');
                    const newsletterBadge = document.getElementById('viewNewsletterBadge');
                    const joined = document.getElementById('viewJoined');
                    const lastActive = document.getElementById('viewLastActive');

                    const time = document.getElementById('viewListeningTime');
                    const completed = document.getElementById('viewCompletedCount');
                    const streak = document.getElementById('viewStreak');

                    const favList = document.getElementById('viewFavoritesList');
                    const favCount = document.getElementById('viewFavCount');
                    const clipsList = document.getElementById('viewClipsList');
                    const clipsCount = document.getElementById('viewClipsCount');
                    const historyList = document.getElementById('viewHistoryList');

                    const container = document.getElementById('adminContainer');
                    const episodesData = container ? JSON.parse(container.dataset.episodes || '{}') : {};
                    const clipsData = container ? JSON.parse(container.dataset.clips || '{}') : {};

                    if(avatar) avatar.src = userData.picture || `https://ui-avatars.com/api/?name=${userData.name}`;
                    if(name) name.textContent = userData.name;
                    if(email) email.textContent = userData.email;
                    
                    if(roleBadge) {
                        roleBadge.className = `role-badge ${userData.role || 'user'}`;
                        roleBadge.textContent = userData.role || 'user';
                    }
                    if(newsletterBadge) {
                        newsletterBadge.className = `status-badge ${userData.newsletter ? 'active' : 'inactive'}`;
                        newsletterBadge.textContent = userData.newsletter ? 'Suscrito' : 'Inactivo';
                    }

                    if(joined) joined.textContent = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString() : 'N/A';
                    if(lastActive) lastActive.textContent = userData.lastActiveAt ? new Date(userData.lastActiveAt).toLocaleString() : (userData.lastLogin ? new Date(userData.lastLogin).toLocaleString() : 'N/A');

                    if(time) time.textContent = userData.listeningTime ? `${Math.floor(userData.listeningTime/3600)}h ${Math.floor((userData.listeningTime%3600)/60)}m` : '0h 0m';
                    if(completed) completed.textContent = (userData.completedEpisodes || []).length.toString();
                    if(streak) streak.textContent = `${userData.currentStreak || 0} / ${userData.maxStreak || 0}`;

                    // Favorites
                    if(favList && favCount) {
                        favList.innerHTML = '';
                        const favs = userData.favorites || [];
                        favCount.textContent = favs.length;
                        if(favs.length === 0) {
                            favList.innerHTML = '<li class="empty-state">Sin favoritos</li>';
                        } else {
                            favs.forEach((slug: string) => {
                                const epData = episodesData[slug];
                                const title = epData ? epData.title : slug;
                                const image = epData ? epData.image : 'https://placehold.co/100x100?text=?';
                                const li = document.createElement('li');
                                li.className = 'mini-item';
                                li.innerHTML = `
                                    <img src="${image}" alt="${title}" class="mini-thumb" />
                                    <div class="mini-info">
                                        <span class="mini-title" title="${title}">${title}</span>
                                    </div>
                                `;
                                favList.appendChild(li);
                            });
                        }
                    }

                    // Liked Clips
                    if(clipsList && clipsCount) {
                        clipsList.innerHTML = '';
                        const clips = userData.likedClips || [];
                        clipsCount.textContent = clips.length;
                        if(clips.length === 0) {
                            clipsList.innerHTML = '<li class="empty-state">Sin clips guardados</li>';
                        } else {
                            clips.forEach((id: string) => {
                                const clipData = clipsData[id];
                                const title = clipData ? clipData.title : id;
                                const image = clipData ? clipData.image : 'https://placehold.co/100x100?text=?';
                                const li = document.createElement('li');
                                li.className = 'mini-item';
                                li.innerHTML = `
                                    <img src="${image}" alt="${title}" class="mini-thumb clip-thumb" />
                                    <div class="mini-info">
                                        <span class="mini-title" title="${title}">${title}</span>
                                        ${clipData ? `<span class="mini-meta">Ep: ${clipData.episodeSlug}</span>` : ''}
                                    </div>
                                `;
                                clipsList.appendChild(li);
                            });
                        }
                    }

                    function formatTimeJS(seconds: number) {
                        if (!seconds) return '0m';
                        const h = Math.floor(seconds / 3600);
                        const m = Math.floor((seconds % 3600) / 60);
                        if (h > 0) return `${h}h ${m}m`;
                        return `${m}m`;
                    }

                    // History
                    if(historyList) {
                        historyList.innerHTML = '';
                        const history = userData.playbackHistory || [];
                        // Sort history by listenedAt desc
                        history.sort((a: any, b: any) => new Date(b.listenedAt).getTime() - new Date(a.listenedAt).getTime());

                        if(history.length === 0) {
                             historyList.innerHTML = '<li class="empty-state">Sin historial de reproducción</li>';
                        } else {
                             history.forEach((h: any) => {
                                const epData = episodesData[h.episodeSlug];
                                const title = epData ? epData.title : h.episodeSlug;
                                const image = epData ? epData.image : 'https://placehold.co/100x100?text=?';
                                
                                // Real progress calculation
                                let progressPercent = 0;
                                if (h.duration > 0) {
                                    progressPercent = Math.min(100, Math.round((h.progress / h.duration) * 100));
                                } else if (h.completed) {
                                    progressPercent = 100;
                                }

                                const li = document.createElement('li');
                                li.className = 'history-item-rich';
                                li.innerHTML = `
                                    <img src="${image}" alt="${title}" class="history-thumb" />
                                    <div class="history-info">
                                        <div class="history-title-row">
                                            <span class="history-title" title="${title}">${title}</span>
                                            <span class="history-date">${new Date(h.listenedAt).toLocaleString([], {year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        <div class="history-meta mt-1">
                                            <span class="progress-text">${formatTimeJS(h.progress)} / ${formatTimeJS(h.duration)}</span>
                                            ${h.completed ? '<span class="badge-completed">✓ Completado</span>' : ''}
                                        </div>
                                        <div class="progress-track-mini mt-2">
                                            <div class="progress-fill-mini" style="width: ${progressPercent}%"></div>
                                        </div>
                                    </div>
                                `;
                                historyList.appendChild(li);
                            });
                        }
                    }

                    openModal(viewModal);
                });
            });

            // Test Email Buttons
            document.querySelectorAll('.test-email-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget as HTMLElement;
                    const userName = target.dataset.name;
                    
                    window.customConfirm(
                        'Enviar Prueba',
                        `¿Quieres enviar un email de prueba con el resumen personalizado a ${userName}?`,
                        async () => {
                            const userId = target.dataset.id;
                            target.style.opacity = '0.5';
                            target.style.pointerEvents = 'none';
                            
                            try {
                                const res = await fetch('/api/admin/newsletter-test', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId })
                                });
                                if (res.ok) {
                                    window.showToast('Email de prueba enviado correctamente a ' + userName, 'success');
                                } else {
                                    const data = await res.json();
                                    window.showToast('Error: ' + (data.error || 'Fallo desconocido'), 'error');
                                }
                            } catch (e) {
                                window.showToast('Error de conexión', 'error');
                            } finally {
                                target.style.opacity = '1';
                                target.style.pointerEvents = 'auto';
                            }
                        }
                    );
                });
            });

            // Test to Me Buttons
            document.querySelectorAll('.test-to-me-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget as HTMLElement;
                    const userName = target.dataset.name;
                    
                    window.customConfirm(
                        'Probar Perfil',
                        `¿Quieres enviarte A TI MISMO un correo de prueba con los datos de ${userName}?`,
                        async () => {
                            const userId = target.dataset.id;
                            target.style.opacity = '0.5';
                            target.style.pointerEvents = 'none';
                            
                            try {
                                const res = await fetch('/api/admin/newsletter-test', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId, sendToMe: true })
                                });
                                if (res.ok) {
                                    window.showToast('Email enviado a tu bandeja de entrada con el perfil de ' + userName, 'success');
                                } else {
                                    const data = await res.json();
                                    window.showToast('Error: ' + (data.error || 'Fallo desconocido'), 'error');
                                }
                            } catch (e) {
                                window.showToast('Error de conexión', 'error');
                            } finally {
                                target.style.opacity = '1';
                                target.style.pointerEvents = 'auto';
                            }
                        }
                    );
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget as HTMLElement;
                    
                    window.customConfirm(
                        'Eliminar Usuario',
                        '¿Estás seguro de que quieres eliminar a este usuario? Esta acción no se puede deshacer.',
                        async () => {
                            const userId = target.dataset.id;
                            try {
                                const res = await fetch('/api/admin/users', {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId })
                                });
                                if (res.ok) {
                                    window.showToast('Usuario eliminado correctamente', 'success');
                                    setTimeout(() => window.location.reload(), 1000);
                                } else {
                                    const data = await res.json();
                                    window.showToast('Error: ' + data.error, 'error');
                                }
                            } catch (e) {
                                window.showToast('Error de conexión', 'error');
                            }
                        }
                    );
                });
            });

            const bulkBtn = document.getElementById('sendBulkNewsletterBtn');
            if (bulkBtn) {
                bulkBtn.onclick = () => {
                    window.customConfirm(
                        'Envío Masivo',
                        '¿Estás seguro de que quieres enviar la newsletter personalizada a TODOS los usuarios suscritos ahora mismo?',
                        async () => {
                            if (!bulkBtn) return;
                            bulkBtn.style.opacity = '0.5';
                            bulkBtn.style.pointerEvents = 'none';
                            const originalText = bulkBtn.innerHTML;
                            bulkBtn.innerHTML = 'Enviando...';

                            try {
                                const res = await fetch('/api/admin/newsletter-bulk', { method: 'POST' });
                                const data = await res.json();
                                if (res.ok) {
                                    window.showToast(`Newsletter enviada: ${data.results.sent} éxitos, ${data.results.errors.length} errores`, 'success');
                                } else {
                                    window.showToast('Error: ' + (data.error || 'Fallo desconocido'), 'error');
                                }
                            } catch (e) {
                                window.showToast('Error de conexión', 'error');
                            } finally {
                                bulkBtn.style.opacity = '1';
                                bulkBtn.style.pointerEvents = 'auto';
                                bulkBtn.innerHTML = originalText;
                            }
                        }
                    );
                };
            }

            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    // Custom form data handling to include checkbox state
                    const idInput = document.getElementById('editUserId') as HTMLInputElement;
                    const nameInput = document.getElementById('editName') as HTMLInputElement;
                    const emailInput = document.getElementById('editEmail') as HTMLInputElement;
                    const bioInput = document.getElementById('editBio') as HTMLTextAreaElement;
                    const roleInput = document.getElementById('editRole') as HTMLSelectElement;
                    const listeningHoursInput = document.getElementById('editListeningHours') as HTMLInputElement;
                    const listeningMinutesInput = document.getElementById('editListeningMinutes') as HTMLInputElement;
                    const listeningSecondsInput = document.getElementById('editListeningSeconds') as HTMLInputElement;
                    const currentStreakInput = document.getElementById('editCurrentStreak') as HTMLInputElement;
                    const maxStreakInput = document.getElementById('editMaxStreak') as HTMLInputElement;
                    const favoritesInput = document.getElementById('editFavorites') as HTMLInputElement;
                    const newsletterInput = document.getElementById('editNewsletter') as HTMLInputElement;

                    const h = parseInt(listeningHoursInput.value) || 0;
                    const m = parseInt(listeningMinutesInput.value) || 0;
                    const s = parseInt(listeningSecondsInput.value) || 0;
                    const totalListeningTime = (h * 3600) + (m * 60) + s;

                    const favArray = favoritesInput.value.split(',')
                                         .map(f => f.trim())
                                         .filter(f => f !== '');

                    const data = {
                        userId: idInput.value,
                        name: nameInput.value,
                        email: emailInput.value,
                        bio: bioInput.value,
                        role: roleInput.value,
                        listeningTime: totalListeningTime,
                        currentStreak: Number(currentStreakInput.value) || 0,
                        maxStreak: Number(maxStreakInput.value) || 0,
                        favorites: favArray,
                        newsletter: newsletterInput.checked
                    };

                    try {
                        const res = await fetch('/api/admin/users', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        if (res.ok) {
                            window.showToast('Usuario actualizado correctamente', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            const err = await res.json();
                            window.showToast('Error: ' + err.error, 'error');
                        }
                    } catch (e) {
                        window.showToast('Error de conexión', 'error');
                    }
                };
            }
        }

        // Run on initial load
        attachEventListeners();

        // Run on view transitions
        document.addEventListener('astro:page-load', attachEventListeners);
    </script>
</Layout>
<style is:inline>
  /* --- God Tier Admin Styles --- */

  /* Container */
  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    color: var(--color-text-main);
    animation: fadeInUp 0.8s ease-out;
  }

  .admin-header {
    margin-bottom: 2.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }

  .admin-header h1 {
    font-size: 3.5rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(to right, #fff, #a78bfa, #f472b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 800;
    letter-spacing: -0.03em;
    filter: drop-shadow(0 0 30px rgba(167, 139, 250, 0.4));
  }
  
  .admin-header p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    letter-spacing: 0.02em;
  }

  .btn-bulk-newsletter {
      background: linear-gradient(135deg, #8b5cf6, #d946ef);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
  }

  .btn-bulk-newsletter:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5);
      filter: brightness(1.1);
  }

  .btn-bulk-newsletter:active {
      transform: translateY(0) scale(0.98);
  }

  /* Glass Panel & Table */
  .section-container {
    padding: 0; /* Remove padding to flush table */
    border-radius: 1.5rem;
    margin-bottom: 2rem;
    overflow: hidden;
    background: rgba(18, 18, 23, 0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
  }

  .table-container { 
      overflow-x: auto; 
      padding: 1rem;
  }

  .modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 0.5rem;
  }

  .modern-table th {
    text-align: left;
    padding: 1rem 1.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-dim);
    font-weight: 700;
    opacity: 0.8;
  }
  
  .modern-table td {
    padding: 1.25rem 1.5rem;
    background: rgba(255,255,255,0.02);
    border-top: 1px solid rgba(255,255,255,0.03);
    border-bottom: 1px solid rgba(255,255,255,0.03);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .modern-table tr td:first-child {
    border-top-left-radius: 1rem;
    border-bottom-left-radius: 1rem;
    border-left: 1px solid rgba(255,255,255,0.03);
  }
  
  .modern-table tr td:last-child {
    border-top-right-radius: 1rem;
    border-bottom-right-radius: 1rem;
    border-right: 1px solid rgba(255,255,255,0.03);
  }

  .modern-table tr:hover td { 
      background: rgba(255,255,255,0.06); 
      transform: scale(1.01);
      border-color: rgba(255,255,255,0.1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 10;
      position: relative;
  }

  /* User Cells */
  .user-cell { display: flex; align-items: center; gap: 1rem; }
  .user-avatar { 
      width: 44px; height: 44px; border-radius: 50%; object-fit: cover; 
      border: 2px solid rgba(255,255,255,0.1); 
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  .user-name { font-weight: 700; color: #fff; font-size: 1rem; }
  .text-muted { color: var(--color-text-muted); font-size: 0.9rem; }
  .text-sm { font-size: 0.85rem; color: var(--color-text-muted); font-family: monospace; }
  .font-mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; opacity: 0.9; }

  /* Badges */
  .role-badge { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
  .role-badge.admin { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.4); box-shadow: 0 0 10px rgba(139, 92, 246, 0.2); }
  .role-badge.owner { background: rgba(244, 114, 182, 0.15); color: #fbcfe8; border: 1px solid rgba(244, 114, 182, 0.4); box-shadow: 0 0 15px rgba(244, 114, 182, 0.3); }
  .role-badge.user { background: rgba(255,255,255,0.03); color: #9ca3af; border: 1px solid rgba(255,255,255,0.1); }
  
  .status-badge { display: inline-flex; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; }
  .status-badge.active { color: #34d399; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
  .status-badge.inactive { color: #f87171; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }

  /* Actions */
  .text-right { text-align: right; }
  .actions-cell { display: flex; justify-content: flex-end; gap: 0.5rem; }
  .icon-btn { 
      background: rgba(255,255,255,0.03); 
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer; 
      padding: 0.5rem; 
      border-radius: 0.75rem; 
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
      color: var(--color-text-muted);
      display: flex; align-items: center; justify-content: center;
  }
  .icon-btn:hover { 
      background: rgba(167, 139, 250, 0.2); 
      color: #fff; border-color: rgba(167, 139, 250, 0.5); 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
  }
  .icon-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2);
  }
  .icon-btn.test-email-btn:hover {
      background: rgba(52, 211, 153, 0.2);
      border-color: rgba(52, 211, 153, 0.5);
      color: #34d399;
      box-shadow: 0 5px 15px rgba(52, 211, 153, 0.2);
  }
  .icon-btn.test-to-me-btn:hover {
      background: rgba(129, 140, 248, 0.2);
      border-color: rgba(129, 140, 248, 0.5);
      color: #818cf8;
      box-shadow: 0 5px 15px rgba(129, 140, 248, 0.2);
  }

  /* MODAL */
  .modal-backdrop { 
      position: fixed; inset: 0; 
      background: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(12px); 
      -webkit-backdrop-filter: blur(12px);
      z-index: 100; 
      display: flex; align-items: center; justify-content: center; 
      padding: 1rem; 
      opacity: 1; transition: opacity 0.3s; 
  }
  .modal-backdrop.hidden { opacity: 0; pointer-events: none; }
  
  .modal-content { 
      background: rgba(20, 20, 25, 0.95);
      border: 1px solid rgba(255,255,255,0.1); 
      width: 100%; max-width: 500px; 
      padding: 2rem; 
      border-radius: 2rem; 
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255,255,255,0.05);
      transform: translateY(0); 
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
      max-height: 90vh;
      overflow-y: auto;
  }
  .modal-content.wide-modal { max-width: 800px; }

  .modal-backdrop.hidden .modal-content { transform: translateY(20px) scale(0.95); }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
  .modal-header h3 { font-size: 1.5rem; font-weight: 800; color: #fff; background: linear-gradient(to right, #fff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .close-btn { background: transparent; border: none; color: var(--color-text-muted); font-size: 2rem; line-height: 1; cursor: pointer; transition: color 0.2s; }
  .close-btn:hover { color: #fff; transform: rotate(90deg); transition: transform 0.3s, color 0.2s; }
  
  .form-group { margin-bottom: 1.5rem; }
  .form-group label { display: block; margin-bottom: 0.5rem; color: var(--color-text-muted); font-size: 0.9rem; font-weight: 500; }
  .modern-input { 
      width: 100%; padding: 1rem; 
      background: rgba(0, 0, 0, 0.4); 
      border: 1px solid rgba(255,255,255,0.1); 
      border-radius: 1rem; 
      color: #fff; font-size: 1rem; 
      transition: all 0.2s; 
  }
  .modern-input:focus { outline: none; border-color: #a78bfa; background: rgba(0,0,0,0.6); box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.1); }
  
  .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
  .btn-cancel { padding: 0.75rem 1.5rem; background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--color-text-muted); border-radius: 1rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
  .btn-cancel:hover { background: rgba(255,255,255,0.05); color: #fff; }
  .btn-save { padding: 0.75rem 2rem; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border: none; color: #fff; border-radius: 1rem; cursor: pointer; font-weight: 700; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); transition: all 0.2s; }
  .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5); filter: brightness(1.1); }

  /* Checkbox & Switch */
  .checkbox-group { margin-top: 1.5rem; }
  .checkbox-label {
      display: flex; align-items: center; gap: 1rem; cursor: pointer;
      padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;
  }
  .checkbox-label:hover { background: rgba(255,255,255,0.05); }
  .checkbox-label input { display: none; }
  .checkbox-custom {
      width: 24px; height: 24px; min-width: 24px; min-height: 24px; flex-shrink: 0;
      border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
  }
  .checkbox-label input:checked + .checkbox-custom { background: #a78bfa; border-color: #a78bfa; box-shadow: 0 0 10px rgba(167, 139, 250, 0.4); }
  .checkbox-label input:checked + .checkbox-custom::after {
      content: '✓'; font-size: 1rem; color: white; font-weight: 800; line-height: 1;
  }
  .label-text { font-weight: 500; font-size: 0.95rem; user-select: none; }

  /* Dashboard User Details Responsive */
  .modal-content.super-wide-modal { max-width: 900px; padding: 0; }
  .modal-header { padding: 2rem 2rem 1.5rem; margin-bottom: 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
  
  .user-dashboard-scrollable { padding: 2rem; max-height: calc(90vh - 85px); overflow-y: auto; }
  
  /* Hero */
  .dashboard-hero {
      display: flex; align-items: flex-start; gap: 2rem; padding-bottom: 2.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 2rem;
  }
  .dashboard-avatar { width: 110px; height: 110px; border-radius: 2rem; object-fit: cover; border: 4px solid rgba(167, 139, 250, 0.2); box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
  
  .hero-info { flex: 1; }
  .hero-title-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
  .hero-title-row h2 { font-size: 2rem; font-weight: 800; color: #fff; margin: 0; letter-spacing: -0.02em; }
  .hero-email { color: var(--color-text-dim); font-size: 1.05rem; margin-bottom: 1rem; }
  .hero-meta { color: var(--color-text-muted); font-size: 0.9rem; font-family: 'JetBrains Mono', monospace; display: flex; align-items: center; gap: 0.5rem; }
  .dot-sep { opacity: 0.5; font-size: 1.2rem; line-height: 0; }

  /* Stat Cards */
  .stats-cards-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;
  }
  .stat-card {
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 1.5rem;
      padding: 1.5rem; display: flex; align-items: center; gap: 1.25rem; transition: all 0.3s;
  }
  .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.05); border-color: rgba(167, 139, 250, 0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
  .stat-icon { width: 50px; height: 50px; border-radius: 1rem; display: flex; align-items: center; justify-content: center; }
  .time-icon { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; }
  .ep-icon { background: rgba(52, 211, 153, 0.15); color: #6ee7b7; }
  .streak-icon { background: rgba(245, 158, 11, 0.15); color: #fcd34d; }
  
  .stat-data h4 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-dim); margin-bottom: 0.25rem; }
  .stat-value { font-size: 1.5rem; font-weight: 700; color: #fff; }

  /* Columns */
  .dashboard-columns { display: grid; grid-template-columns: 1.6fr 1fr; gap: 2rem; }
  .section-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.75rem; }
  .section-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; color: #a78bfa; margin: 0; }

  .rich-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 1rem; }
  .empty-state { padding: 2rem; text-align: center; color: var(--color-text-dim); background: rgba(255,255,255,0.02); border-radius: 1rem; border: 1px dashed rgba(255,255,255,0.1); font-size: 0.9rem; }

  /* History Rich Items */
  .history-list-wrapper { max-height: 500px; overflow-y: auto; padding-right: 0.5rem; }
  .history-list-wrapper::-webkit-scrollbar { width: 6px; }
  .history-list-wrapper::-webkit-scrollbar-thumb { background: rgba(167, 139, 250, 0.3); border-radius: 10px; }
  
  .history-item-rich {
      display: flex; gap: 1.25rem; padding: 1.25rem;
      background: rgba(0,0,0,0.3); border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.04); transition: all 0.2s;
  }
  .history-item-rich:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
  .history-thumb { width: 70px; height: 70px; border-radius: 0.75rem; object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.4); flex-shrink: 0; }
  
  .history-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
  .history-title-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
  .history-title { font-weight: 700; font-size: 1.05rem; color: #fff; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .history-date { font-size: 0.75rem; color: var(--color-text-dim); white-space: nowrap; font-family: monospace; }
  
  .history-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
  .progress-text { font-family: 'JetBrains Mono', monospace; color: #a78bfa; font-weight: 600; }
  .badge-completed { font-size: 0.7rem; font-weight: 800; background: rgba(52, 211, 153, 0.15); color: #34d399; padding: 0.2rem 0.6rem; border-radius: 99px; }
  
  .progress-track-mini { height: 6px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; }
  .progress-fill-mini { height: 100%; background: linear-gradient(90deg, #a78bfa, #f472b6); border-radius: 99px; }

  /* Side Lists (Mini) */
  .mini-list { max-height: 250px; overflow-y: auto; padding-right: 0.5rem; }
  .mini-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.02); border-radius: 0.75rem; transition: background 0.2s; border: 1px solid transparent; }
  .mini-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.08); }
  .mini-thumb { width: 44px; height: 44px; border-radius: 0.5rem; object-fit: cover; }
  .clip-thumb { aspect-ratio: 9/16; width: 34px; height: 60px; }
  .mini-info { flex: 1; min-width: 0; display: flex; flex-direction: column; }
  .mini-title { font-weight: 600; font-size: 0.9rem; color: #e5e7eb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mini-meta { font-size: 0.75rem; color: var(--color-text-dim); margin-top: 0.2rem; }

  .mt-1 { margin-top: 0.25rem; }
  .mt-2 { margin-top: 0.75rem; }
  .mt-4 { margin-top: 2rem; }

  /* Responsive Adjustments */
  @media (max-width: 900px) {
      .dashboard-columns { grid-template-columns: 1fr; }
      .dashboard-hero { flex-direction: column; align-items: center; text-align: center; }
      .hero-title-row { justify-content: center; }
      .hero-meta { justify-content: center; flex-wrap: wrap; }
      .stats-cards-grid { grid-template-columns: 1fr; }
      .user-dashboard-scrollable { padding: 1.5rem; }
  }

  /* Blobs */
  .blob { position: absolute; width: 600px; height: 600px; border-radius: 50%; filter: blur(100px); opacity: 0.08; z-index: -1; pointer-events: none; }
  .blob-1 { top: -200px; left: -200px; background: #8b5cf6; }
  .blob-2 { bottom: -200px; right: -200px; background: #ec4899; }
  .grid-overlay { position: absolute; inset: 0; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(circle at center, black 40%, transparent 100%); opacity: 0.4; pointer-events: none; }
</style>

